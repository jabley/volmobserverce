
Widget.Animable=Class.define({framesPerSecond:50});Widget.Scrollable=Class.define(Widget.Animable,{charsPerSecond:6,direction:"left",getCharsPerSecond:function(){return this.charsPerSecond;},getCharWidth:function(){if(!Widget.charWidth){this.mElement=document.createElement("span");this.mElement.style.visibility="hidden";this.mElement.style.padding="0px";this.mElement.style.border="0px";this.mElement.style.margin="0px";this.mElement.appendChild(document.createTextNode("M"));document.body.appendChild(this.mElement);Widget.charWidth=this.mElement.scrollWidth;this.mElement.style.display="none";document.body.removeChild(this.mElement);Widget.charWidth=Widget.charWidth?Widget.charWidth:16;}
return Widget.charWidth;},getPixelsPerSecond:function(){return this.getCharsPerSecond()*this.getCharWidth();},getDirection:function(){return this.direction;}});Widget.Repeatable=Class.define({repetitions:"infinite",getRepetitions:function(){return this.repetitions;}});Widget.Animator=Class.define(Widget.Scrollable,Widget.OptionsContainer,{initialize:function(options){this.installOptions(options);this.millisElapsed=0;this.running=false;},setRenderCallback:function(callback){this.callback=callback;},isPlaying:function(){return this.playing;},isPaused:function(){return this.paused;},start:function(){if(!this.playing){this.playing=true;this.millisElapsed=0;this.updateTimer();}},stop:function(){if(this.playing){this.playing=false;this.updateTimer();}},pause:function(){if(!this.paused){this.paused=true;this.updateTimer();}},resume:function(){if(this.paused){this.paused=false;this.updateTimer();}},render:function(){if(this.callback){this.callback(this.millisElapsed);}},updateTimer:function(){if(this.playing&&!this.paused){if(!this.timer){this.lastMillis=(new Date()).getTime();this.timer=setInterval(this.nextFrame.bind(this),1000/this.framesPerSecond);}}else{if(this.timer){clearInterval(this.timer);this.timer=null;}}},nextFrame:function(){var currentMillis=(new Date()).getTime();this.millisElapsed+=currentMillis-this.lastMillis;this.lastMillis=currentMillis;this.render();}});Widget.Refresher=Class.define(Widget.OptionsContainer,{url:null,interval:60,callback:null,enabled:true,initialize:function(options){this.installOptions(options);this.updateState();},setURL:function(url){this.url=url;this.updateState();},setInterval:function(interval){this.clearTimer();this.interval=interval;this.updateState();},setEnabled:function(enabled){this.enabled=enabled;this.updateState();},setCallback:function(callback){this.callback=callback;this.updateState();},refreshOnTimeout:function(){if(Widget.isPollingEnabled()){this.refresh();}},refresh:function(){if(this.url){new Widget.AjaxRequest(this.url,{method:"get",onSuccess:this.refreshRequest.bind(this)});}},updateState:function(){if(this.enabled&&this.interval){if(!this.timer){this.timer=setInterval(this.refreshOnTimeout.bind(this),this.interval*1000);}}else{this.clearTimer();}},clearTimer:function(){if(this.timer){clearInterval(this.timer);this.timer=null;}},refreshRequest:function(request){if(this.callback){this.callback(request.responseText);}}});Widget.BaseTape=Class.define(Widget.OptionsContainer,{outerElement:null,innerElement:null,offset:null,scrollTimer:null,scrollFPS:null,scrollPPF:null,scrollDirection:null,scrollStyle:null,minScrollOffset:null,maxScrollOffset:null,hasFocus:false,mouseOver:false,initialize:function(id,options){this.element=$(id);this.initialContents=this.element.innerHTML;this.element.style.overflow="hidden";if(Prototype.nokiaOSSBrowser()){this.element.innerHTML="";this.widgetWidth=this.element.getStyle('width');}
this.element.innerHTML="<div style='overflow:hidden; text-align:left; width:100%; height:100%; position: relative; left: 0px; top: 0px;'></div>";this.outerElement=this.element.firstChild;this.outerElement.innerHTML="<div style='position:relative; left:0'></div>";this.middleElement=this.outerElement.firstChild;this.middleElement.innerHTML="<span style='white-space:nowrap'></span>";this.innerElement=this.middleElement.firstChild;this.innerElement.innerHTML=this.initialContents;if(Prototype.nokiaOSSBrowser()){this.element.style.width=this.widgetWidth;}
this.offset=0;this.outerElement.style.minHeight=this.outerElement.scrollHeight+"px";},getWidth:function(){return this.outerElement.clientWidth;},getHeight:function(){return this.outerElement.clientHeight;},getContentsWidth:function(){return this.innerElement.scrollWidth;},getContentsHeight:function(){return this.middleElement.scrollHeight;},getContents:function(html){return this.innerElement.innerHTML;},setContent:function(html){this.innerElement.innerHTML=html;},setContentElement:function(element){while(this.innerElement.firstChild!==null){this.innerElement.removeChild(this.innerElement.firstChild);}
this.innerElement.appendChild(element);},getOffset:function(){return this.offset;},setOffset:function(offset){this.middleElement.style.left=offset+"px";this.middleElement.style.top=((this.getHeight()-this.getContentsHeight())/2)+"px";this.outerElement.scrollLeft=0;this.outerElement.scrollTop=0;this.offset=offset;}});Widget.AbstractTape=Class.define(Widget.OptionsContainer,Widget.Focusable,{initialize:function(id,options){this.initializeAbstractTape(id,options);},initializeAbstractTape:function(id,options){this.installOptions(options);this.tape=new Widget.BaseTape(id,options);this.tapeElement=$(id);this.installObservers(this.tapeElement);this.animator=new Widget.Animator(this.getOption("scroll"));this.animator.setRenderCallback(this.doRender.bind(this));this.animator.start();this.refresher=new Widget.Refresher(this.getOption("refresh"));this.refresher.setCallback(this.setContent.bind(this));},installObservers:function(tapeElement){this.setFocus(tapeElement,this.handleFocus.bindAsEventListener(this),this.handleBlur.bindAsEventListener(this));},removeObservers:function(tapeElement){this.unsetFocus(tapeElement,this.handleFocus.bindAsEventListener(this),this.handleBlur.bindAsEventListener(this));},setContent:function(html){this.setAbstractTapeContents(html);},setContentElement:function(element){this.setAbstractTapeContentElement(element);},setContentNow:function(html){this.setContent(html);},setContentElementNow:function(element){this.setContentElement(element);},setAbstractTapeContents:function(html){this.removeObservers(this.tapeElement);this.tape.setContent(html);this.installObservers(this.tapeElement);},setAbstractTapeContentElement:function(element){this.removeObservers(this.tapeElement);this.tape.setContentElement(element);this.installObservers(this.tapeElement);},refreshContent:function(){this.refresher.refresh();},doRender:function(millis){if(this.tapeElement.isVisible()){this.render(millis);}},render:function(milis){},handleMouseOver:function(){this.mouseOver=true;this.animator.pause();},handleMouseOut:function(){this.mouseOver=false;if(!this.hasFocus){this.animator.resume();}},handleFocus:function(){this.hasFocus=true;this.animator.pause();},handleBlur:function(){this.hasFocus=false;if(!this.mouseOver){this.animator.resume();}}});Widget.SlidingTape=Class.define(Widget.AbstractTape,{render:function(millis){var shift=(millis/1000)*this.animator.getPixelsPerSecond();if(shift>=this.tape.getWidth()){shift=this.tape.getWidth();this.animator.stop();}
if(this.animator.direction=="left"){this.tape.setOffset(this.tape.getWidth()-shift);}else{this.tape.setOffset(shift-this.tape.getContentsWidth());}},setContent:function(html){this.animator.stop();this.setAbstractTapeContents(html);this.animator.start();},setContentElement:function(element){this.animator.stop();this.setAbstractTapeContentElement(element);this.animator.start();}});Widget.AlternatingTape=Class.define(Widget.AbstractTape,Widget.Repeatable,{render:function(millis){var shift=(millis/1000)*this.animator.getPixelsPerSecond();d=(this.tape.getWidth()-this.tape.getContentsWidth())/2;d1=Math.abs(d);d2=d1*2;d3=d1*3;d4=d1*4;if(this.repetitions&&(this.repetitions!="infinite")&&(shift>=d4*this.repetitions)){s=0;this.animator.stop();}else{s=shift%d4;if(s<d1){s=-s;}else if(s<d3){s=s-d2;}else{s=d4-s;}
if(this.animator.direction=="right"){s=-s;}}
this.tape.setOffset(d+s);},setContent:function(html){this.animator.stop();this.setAbstractTapeContents(html);this.animator.start();},setContentElement:function(element){this.animator.stop();this.setAbstractTapeContentElement(element);this.animator.start();}});Widget.ScrollingTape=Class.define(Widget.AbstractTape,Widget.Repeatable,{newContents:null,newOffset:null,offset:0,shift:0,render:function(millis){this.offset=(millis/1000)*this.animator.getPixelsPerSecond()-this.shift;cycleWidth=this.tape.getWidth()+this.tape.getContentsWidth();if(this.repetitions&&(this.repetitions!="infinite")&&(this.offset>=cycleWidth*this.repetitions)){this.animator.stop();return;}
if(this.newOffset&&this.offset>=this.newOffset){this.tape.setOffset(this.tape.getWidth());if(this.newContents!=null){this.setAbstractTapeContents(this.newContents);}else if(this.newContentElement!=null){this.setAbstractTapeContentElement(this.newContentElement);}
this.shift+=this.newOffset;this.offset-=this.newOffset;this.newContents=null;this.newContentElement=null;this.newOffset=null;}
var tapeOffset=this.offset%(this.tape.getWidth()+this.tape.getContentsWidth());if(this.animator.direction=="left"){this.tape.setOffset(this.tape.getWidth()-tapeOffset);}else{this.tape.setOffset(-this.tape.getContentsWidth()+tapeOffset);}},setContent:function(html){if(this.animator.isPlaying()){this.newContents=html;var cycleLength=(this.tape.getWidth()+this.tape.getContentsWidth());this.newOffset=Math.ceil(this.offset/cycleLength)*cycleLength;}else{this.setAbstractTapeContents(html);this.shift=0;this.animator.start();}},setContentElement:function(element){if(this.animator.isPlaying()){Widget.log("TickerTape"," playing adding content element");this.newContentElement=element;var cycleLength=(this.tape.getWidth()+this.tape.getContentsWidth());this.newOffset=Math.ceil(this.offset/cycleLength)*cycleLength;}else{Widget.log("TickerTape"," not playing adding content element");this.setAbstractTapeContentElement(element);this.shift=0;this.animator.start();}},setContentNow:function(html){this.animator.stop();this.shift=0;this.render(0);this.setAbstractTapeContents(html);this.animator.start();},setContentElementNow:function(element){this.animator.stop();this.shift=0;this.render(0);this.setAbstractTapeContentElement(element);this.animator.start();}});Widget.TickerTape=Class.define(Widget.OptionsContainer,{style:"scroll",initialize:function(id,options){this.installOptions(options);if(this.style=="slide"){this.tape=new Widget.SlidingTape(id,options);}else if(this.style=="alternate"){this.tape=new Widget.AlternatingTape(id,options);}else if(this.style=="scroll"){this.tape=new Widget.ScrollingTape(id,options);}else if(this.style=="none"){this.tape=new Widget.BaseTape(id,options);}else{this.tape=new Widget.ScrollingTape(id,options);}},refreshContent:function(){this.tape.refreshContent();},forceUpdate:function(){this.refreshContent();},setContent:function(htmlText){this.tape.setContent(htmlText);},setContentNow:function(htmlText){this.tape.setContentNow(htmlText);},setContentElement:function(element){this.tape.setContentElement(element);},setContentElementNow:function(element){this.tape.setContentElementNow(element);}});