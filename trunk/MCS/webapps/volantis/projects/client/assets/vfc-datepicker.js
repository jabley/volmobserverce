
Widget.DatePicker=Widget.define(Widget.Appearable,Widget.Disappearable,{inputField:null,dayInputField:null,monthInputField:null,yearInputField:null,unfoldon:'click',load_src:null,load_when:null,initialize:function(id,blockId,options){this.initializeWidget(null,options)
this.id=blockId;this.block=$W(blockId);this.calendarTable=$(options.calendarDisplayId);this.calendar=new Calendar(options,this.id);this.prepareInputField();this.calendarTable.appendChild(this.calendar.createTableBody());this.addAction('next-month')
this.addAction('previous-month')
this.addAction('next-year')
this.addAction('previous-year')
this.addAction('set-today')
this.addAction('dismiss')
this.addAction('show')
this.addProperty('month')
this.addProperty('year')
this.client=new Widget.Internal.Client();this.observe(this.client,"requestSucceeded","clientRequestSucceeded");this.observe(this.client,"requestFailed","clientRequestFailed");this.observe(this.client,"requestInterrupted","clientRequestInterrupted");this.observe(this.block,"isHiddenChanged","_blockHiddenChanged");if(this.load_src!=0&&this.load_when!='defer')
this.loadConfiguration();},clientRequestSucceeded:function(pickerResponse){Widget.log("DatePicker","Request succeeded")
myDate=new MyDate();myDate.setDateFromISODate(pickerResponse.getCurrentDate())
this.calendar.setStartDate(myDate);this.calendar.startRange.setDateFromISODate(pickerResponse.getRangeStart());this.calendar.endRange.setDateFromISODate(pickerResponse.getRangeEnd());Widget.log("DatePicker","this.calendar.startRange"+this.calendar.startRange.dateToString())
Widget.log("DatePicker","this.calendar.endRange"+this.calendar.endRange.dateToString())
this.calendar.refreshCalendar();this.notifyObservers("monthChanged");this.notifyObservers("yearChanged");this.notifyObservers("canNextMonthChanged");this.notifyObservers("canPreviousMonthChanged");this.notifyObservers("canNextYearChanged");this.notifyObservers("canPreviousYearChanged");},clientRequestFailed:function(message){Widget.log("DatePicker","Request failed")},clientRequestInterrupted:function(){Widget.log("DatePicker","Request interrupted")},getMonth:function(){return this.calendar.getMonth().toString()},getYear:function(){return this.calendar.getYear().toString()},prepareInputField:function(){var u=(this.unfoldon=='click')?Widget.CLICK:Widget.FOCUS
if(Prototype.operaMobile())u=Widget.FOCUS;if(this.inputField!=null){this.inputField=$(this.inputField);Widget.addElementObserver(this.inputField,u,this.show.bindAsEventListener(this));}else{if(this.dayInputField!=null){this.dayInputField=$(this.dayInputField);Widget.addElementObserver(this.dayInputField,u,this.show.bindAsEventListener(this));}
if(this.monthInputField!=null){this.monthInputField=$(this.monthInputField);Widget.addElementObserver(this.monthInputField,u,this.show.bindAsEventListener(this));}
if(this.yearInputField!=null){this.yearInputField=$(this.yearInputField);Widget.addElementObserver(this.yearInputField,u,this.show.bindAsEventListener(this));}}},dismiss:function(){if(this.canDismiss()){this.block.hide();this.notifyObservers("dismissed");}},previousMonth:function(){this.calendar.prevMonth();this.notifyObservers("monthChanged")
this.notifyObservers("yearChanged")
this.notifyObservers("canNextMonthChanged")
this.notifyObservers("canPreviousMonthChanged")
this.notifyObservers("canNextYearChanged")
this.notifyObservers("canPreviousYearChanged")},nextMonth:function(){this.calendar.nextMonth();this.notifyObservers("monthChanged")
this.notifyObservers("yearChanged")
this.notifyObservers("canNextMonthChanged")
this.notifyObservers("canPreviousMonthChanged")
this.notifyObservers("canNextYearChanged")
this.notifyObservers("canPreviousYearChanged")},previousYear:function(){this.calendar.prevYear();this.notifyObservers("monthChanged")
this.notifyObservers("yearChanged")
this.notifyObservers("canNextMonthChanged")
this.notifyObservers("canPreviousMonthChanged")
this.notifyObservers("canNextYearChanged")
this.notifyObservers("canPreviousYearChanged")},nextYear:function(){this.calendar.nextYear();this.notifyObservers("monthChanged")
this.notifyObservers("yearChanged")
this.notifyObservers("canNextMonthChanged")
this.notifyObservers("canPreviousMonthChanged")
this.notifyObservers("canNextYearChanged")
this.notifyObservers("canPreviousYearChanged")},canNextMonth:function(){var monthAfter=new MyDate(1,this.calendar.month+1,this.calendar.getYear());var end=this.calendar.endRange;return!monthAfter.isLater(end);},canPreviousMonth:function(){var monthBefore=new MyDate(31,this.calendar.month-1,this.calendar.getYear());var start=this.calendar.startRange;return!start.isLater(monthBefore);},canNextYear:function(){var yearAfter=new MyDate(1,this.calendar.month,this.calendar.getYear()+1);var end=this.calendar.endRange;return!yearAfter.isLater(end);},canPreviousYear:function(){var yearBefore=new MyDate(31,this.calendar.month,this.calendar.getYear()-1);var start=this.calendar.startRange;return!start.isLater(yearBefore);},setToday:function(){this.calendar.returnToday();},loadConfiguration:function(){this.client.setURL(this.load_src)
var parameters={};this.client.setParameters(parameters);this.client.sendRequest();},setDismisses:function(dismisses){this.dismisses=dismisses||{};for(property in dismisses){var dismiss=$(property);Widget.addElementObserver(dismiss,Widget.CLICK,this.hideAndRunCallback.bindAsEventListener(this));Widget.makeFocusable(dismiss);}},show:function(){if(this.load_src!=0&&this.load_when=='defer')this.loadConfiguration();this.calendar.refreshCalendar();this.notifyObservers("monthChanged");this.notifyObservers("yearChanged");this.notifyObservers("canNextMonthChanged");this.notifyObservers("canPreviousMonthChanged");this.notifyObservers("canNextYearChanged");this.notifyObservers("canPreviousYearChanged");if(this.canShow()){this.block.show();}},hide:function(){this.dismiss();},canShow:function(){return this.block.isHidden();},canDismiss:function(){return(!this.block.isHidden());},isHidden:function(){return this.block.isHidden();},_blockHiddenChanged:function(){this.notifyObservers("canShowChanged");this.notifyObservers("canDismissChanged");},setDateFormat:function(format){this.calendar.dateFormat=format;},setDateStyle:function(day,month,year,style){this.calendar.setDateStyle(day,month-1,year,style);},setDayOfWeekStyle:function(day,style){this.calendar.setDayOfWeekStyle(day,style);},setDisabledDate:function(d,m,y){this.calendar.setDisabledDate(d,m-1,y)},setDisabledStyle:function(s){this.calendar.disabledStyle=s;},setDateFormat:function(format){this.calendar.dateFormat=format;},setStartRange:function(d,m,y){this.calendar.startRange=new MyDate(d,m-1,y);},setEndRange:function(d,m,y){this.calendar.endRange=new MyDate(d,m-1,y);},setMonthNames:function(){for(var i=0;i<arguments.length;i++){this.calendar.monthNames[i]=arguments[i];}},setDayNames:function(){for(var i=0;i<arguments.length;i++){this.calendar.dayNames[i]=arguments[i];}},setDayHeaders:function(){this.calendar.setDayHeaders(arguments);},setWeekStartDay:function(day){this.calendar.weekStartDay=day;},setDayOfWeekStyle:function(day,style){this.calendar.setDayOfWeekStyle(day,style);},setDisabledDate:function(day,month,year){var d=new MyDate(day,month-1,year);this.calendar.disabledDates[d.dateToString()]=true;},setDisabledWeekDays:function(){Widget.log("DatePicker","setDisabledWeekDays")
this.calendar.setDisabledWeekDays(arguments);},setDisabledStyle:function(style){this.calendar.disabledStyle=style;},setStartDate:function(day,month,year){this.calendar.setStartDate(new MyDate(day,month-1,year));},getSelectedDate:function(){return this.calendar.returnededDate.dateToString();}});Calendar=Class.define(Widget.Observer,{initialize:function(options,id){this.monthNames=new Array("January","February","March","April","May","June","July","August","September","October","November","December");this.dayNames=new Array("Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday");this.dayHeaders=new Array("S","M","T","W","T","F","S");this.daysinmonth=new Array(31,28,31,30,31,30,31,31,30,31,30,31);this.weekStartDay=1;this.currentDate=null;this.disabledStyle={'color':'gray'}
this.focusedStyle={'color':'white','backgroundColor':'black'};this.inputField=null;this.dayInputField=null;this.monthInputField=null;this.yearInputField=null;this.id=id;Object.copyFields(this,options||{});this.startRange;this.endRange;this.prepareInputField();this.dateFormat="DD/MM/YYYY";this.buttons=new Array();this.divs=new Array();this.tds=new Array();this.startRange=new MyDate(1,0,1);this.endRange=new MyDate(1,0,3000);this.setStartDate(new MyDate());this.dateStyles={};this.monthStyles={};this.yearStyles={};this.dayOfWeekStyles={};this.dateOfYearStyles={};this.monthOfYearStyles={};this.dayOfYearStyles={};this.dayOfMonthStyles={};this.disabledDates={},this.disabledWeekDays={},this.disabledDivs={};},prepareInputField:function(){if(this.inputField!=null){this.inputField=$(this.inputField);}else{if(this.dayInputField!=null)this.dayInputField=$(this.dayInputField);if(this.monthInputField!=null)this.monthInputField=$(this.monthInputField);if(this.yearInputField!=null)this.yearInputField=$(this.yearInputField);}},setDateStyle:function(day,month,year,style){if(day<1&&month<0){this.yearStyles[year]=style;}else if(day<1&&year==0){this.monthStyles[month]=style;}else if(month<0&&year==0){this.dayOfMonthStyles[day]=style;}else if(year==0){this.dateOfYearStyles[day+"."+month]=style;}else if(day<1){this.monthOfYearStyles[month+"."+year]=style;}else if(month<0){this.dayOfYearStyles[day+"."+year]=style;}else{var d=new MyDate(day,month,year);this.dateStyles[d.dateToString()]=style;}},setDayOfWeekStyle:function(day,style){this.dayOfWeekStyles[day]=style;},setDisabledDate:function(day,month,year){var d=new MyDate(day,month,year);this.disabledDates[d.dateToString()]=true;},setDisabledWeekDays:function(array){Widget.log("DatePicker","calendar setDisabledWeekDays");for(var i=0;i<array.length;i++){Widget.log("DatePicker",array[i]);this.disabledWeekDays[array[i]]=true;}},setDayHeaders:function(daysList){var newHeader=document.createElement('TR');var parent=this.trHeader.parentNode;for(var j=0;j<7;j++){var td=document.createElement('TH')
td=Element.extend(td)
newHeader.appendChild(td);var span=document.createElement('SPAN');td.appendChild(span);var node=document.createTextNode(daysList[(this.weekStartDay+j)%7])
span.appendChild(node);}
parent.insertBefore(newHeader,this.trHeader);parent.removeChild(this.trHeader);this.trHeader=newHeader;},setDisabledStyle:function(style){this.disabledStyle=style;},applyFocusStyle:function(i){if(!this.disabledDivs[i])this.divs[i].vfcReplaceStyle(this.focusedStyle);},applyBlurStyle:function(i,col){if(this.disabledDivs[i])return;var d=this.retrieveFocusedDate(i);this.divs[i].vfcRevertStyle();this.applyStyle(d,i,col);},createTableBody:function(){this.tbody=document.createElement('TBODY');Element.setStyle(this.tbody,{'width':'100%','height':'100%'});this.trHeader=document.createElement('TR');this.tbody.appendChild(this.trHeader);for(var j=0;j<7;j++){var td=document.createElement('TH')
td=Element.extend(td)
this.trHeader.appendChild(td);var span=document.createElement('SPAN');td.appendChild(span);var node=document.createTextNode(this.dayHeaders[(this.weekStartDay+j)%7])
span.appendChild(node);}
var tr;var i=1;for(var row=1;row<=6;row++){this.tbody.appendChild(tr=document.createElement('TR'));for(var col=1;col<=7;col++){tr.appendChild(td=document.createElement('TD'));td=Element.extend(td)
this.tds[i]=td;this.divs[i]=Element.extend(document.createElement('DIV'))
Element.setStyle(this.divs[i],{'text-align':'center'});var f=this.applyFocusStyle.bind(this,i).bindAsEventListener(this)
var b=this.applyBlurStyle.bind(this,i,col).bindAsEventListener(this)
Widget.addElementObserver(this.divs[i],Widget.FOCUS,f);Widget.addElementObserver(this.divs[i],Widget.BLUR,b);this.buttons[i]=new Widget.Internal.Button(this.divs[i]);this.observe(this.buttons[i],"pressed","buttonPressed",i)
td.appendChild(this.divs[i]);i++;}}
this.fillCalendar();return this.tbody;},buttonPressed:function(i){this.returnDate(i)},netfrontButtonSetInnerHTML:function(el,v){el.innerHTML="<input type='button' style='width:1px; height:1px; backgroundColor:transparent; border:0px'>"+v;},netfrontButtonGetInnerHTML:function(el){var s=el.innerHTML;s=s.split(">");return s[1];},setEnabled:function(i,enabled){this.buttons[i].setEnabled(enabled);if(Prototype.firefoxBrowser()||Prototype.msieBrowser()){if(enabled){this.divs[i].tabIndex="0"}else{this.divs[i].removeAttribute('tabIndex');}}
this.disabledDivs[i]=!enabled;},fillCalendar:function(){var i=1;var disabled=false;var d;if(this.monthStyles[this.month]){this.tbody.vfcReplaceStyle(this.monthStyles[this.month]);}else if(this.yearStyles[this.year]){this.tbody.vfcReplaceStyle(this.yearStyles[this.year]);}else if(this.monthOfYearStyles[this.month+"."+this.year]){this.tbody.vfcReplaceStyle(this.monthOfYearStyles[this.month+"."+this.year]);}else{this.tbody.vfcRevertStyle();}
for(var row=1;row<=6;row++){for(var col=1;col<=7;col++){var selected_date=this.display_date;var selected_month=this.display_month;var selected_year=this.display_year;if(Prototype.netFront())this.netfrontButtonSetInnerHTML(this.divs[i],this.display_date)
else this.divs[i].innerHTML=this.display_date;d=new MyDate(this.display_date,this.display_month,this.display_year);if(this.display_month==this.month&&d.isLaterOrEqual(this.startRange)&&this.endRange.isLaterOrEqual(d)){this.setEnabled(i,true);}else{this.setEnabled(i,false);}
if(this.disabledDates[d.dateToString()]||this.disabledWeekDays[col]){this.setEnabled(i,false);}
this.applyStyle(d,i,col);this.display_date++;if(this.display_date>this.daysinmonth[this.display_month]){this.display_date=1;this.display_month++;}
if(this.display_month>11){this.display_month=0;this.display_year++;}
i++;}}
return this.tbody;},applyStyle:function(d,i,col){if(this.dateStyles[d.dateToString()]){this.divs[i].vfcReplaceStyle(this.dateStyles[d.dateToString()]);}else if(this.disabledDates[d.dateToString()]){this.divs[i].vfcReplaceStyle(this.disabledStyle);}else if(this.dateOfYearStyles[d.getDate()+"."+d.getMonth()]){this.divs[i].vfcReplaceStyle(this.dateOfYearStyles[d.getDate()+"."+d.getMonth()]);}else if(this.monthOfYearStyles[d.getMonth()+"."+d.getYear()]){this.divs[i].vfcReplaceStyle(this.monthOfYearStyles[d.getMonth()+"."+d.getYear()]);}else if(this.dayOfMonthStyles[d.getDate()]){this.divs[i].vfcReplaceStyle(this.dayOfMonthStyles[d.getDate()]);}else if(this.dayOfWeekStyles[col]){this.divs[i].vfcReplaceStyle(this.dayOfWeekStyles[col]);}else if(this.dayOfYearStyles[d.getDate()+"."+d.getYear()]){this.divs[i].vfcReplaceStyle(this.dayOfYearStyles[d.getDate()+"."+d.getYear()]);}else if(this.disabledWeekDays[col]){this.divs[i].vfcReplaceStyle(this.disabledStyle);}},refreshCalendar:function(){this.setStartDate(this.currentDate);return this.fillCalendar();},retrieveFocusedDate:function(day){var d=new MyDate();d.date=this.divs[day].innerHTML;d.month=this.month;d.year=this.getYear();return d;},returnDate:function(day){var i;if(day>-1){if(Prototype.netFront())i=this.netfrontButtonGetInnerHTML(this.divs[day]);else i=this.divs[day].innerHTML;this.returnedDate=new MyDate(i,this.month,this.year);}else{this.returnedDate=new MyDate();i=this.returnedDate.getDate();this.month=this.returnedDate.getMonth();this.year=this.returnedDate.getYear();}
if(this.inputField!=null){this.inputField.value=this.formatDate(this.returnedDate,this.dateFormat);}else{if(this.dayInputField!=null)this.dayInputField.value=i;if(this.monthInputField!=null)this.monthInputField.value=this.month+1;if(this.yearInputField!=null)this.yearInputField.value=this.year;}
Widget.getInstance(this.id).hide();this.setStartDate(this.returnedDate);return this.returnededDate;},returnToday:function(){this.returnDate(-1);},LZ:function(x){return(x<0||x>9?"":"0")+x},formatDate:function(date,format){format=format+"";var result="";var i_format=0;var c="";var token="";var Y=date.getYear()+"";var M=date.getMonth()+1;var D=date.getDate();var N=this.monthNames[date.getMonth()];var YYYY,YY,MMM,MM,DD;var value=new Object();if(Y.length<4){Y=""+(Y-0+1900);}
value["Y"]=""+Y;value["YYYY"]=Y;value["YY"]=Y.substring(2,4);value["M"]=M;value["MM"]=this.LZ(M);value["D"]=D;value["DD"]=this.LZ(D);value["N"]=N;while(i_format<format.length){c=format.charAt(i_format);token="";while((format.charAt(i_format)==c)&&(i_format<format.length)){token+=format.charAt(i_format++);}
if(value[token]!=null){result=result+value[token];}
else{result=result+token;}}
return result;},nextMonth:function(){this.month++;if(this.month>11){this.month=0;this.year++;}
this.calculateDates();this.fillCalendar();return this.tbody;},prevMonth:function(){this.month--;if(this.month<0){this.month=11;this.year--;}
this.calculateDates();this.fillCalendar();return this.tbody;},getMonth:function(){return this.monthNames[this.month];},nextYear:function(){this.year++;this.calculateDates();this.fillCalendar();return this.tbody;},prevYear:function(){this.year--;this.calculateDates();this.fillCalendar();return this.tbody;},getYear:function(){return this.year;},getCurrentDate:function(){return this.currentDate;},setStartDate:function(date){Widget.log("DatePicker","seting start date"+this.startRange.dateToString())
this.currentDate=date;if(this.currentDate.isLater(this.endRange)){this.currentDate=this.endRange;}else if(this.startRange.isLater(this.currentDate)){this.currentDate=this.startRange;}
this.month=this.currentDate.getMonth();this.year=this.currentDate.getFullYear();this.calculateDates();},calculateDates:function(){if(((this.year%4==0)&&(this.year%100!=0))||(this.year%400==0)){this.daysinmonth[1]=29;}else{this.daysinmonth[1]=28}
this.current_month=new Date(this.year,this.month,1);this.display_year=this.year;this.display_month=this.month;this.display_date=1;this.weekday=this.current_month.getDay();this.offset=0;this.offset=(this.weekday>=this.weekStartDay)?this.weekday-this.weekStartDay:7-this.weekStartDay+this.weekday;if(this.offset>0){this.display_month--;if(this.display_month<0){this.display_month=11;this.display_year--;}
this.display_date=this.daysinmonth[this.display_month]-this.offset+1;}
this.next_month=this.month+1;this.next_month_year=this.year;if(this.next_month>11){this.next_month=0;this.next_month_year++;}
this.last_month=this.month-1;this.last_month_year=this.year;if(this.last_month<0){this.last_month=11;this.last_month_year--;}}});MyDate=Class.create();Object.extend(MyDate.prototype,{initialize:function(date,month,year){if(arguments.length==0){this.myDateFromDate(new Date());}else{this.date=date;this.month=month;this.year=year;}},getDate:function(){return this.date;},getMonth:function(){return this.month;},getYear:function(){return this.year;},isLater:function(d){if(this.year>d.year)return true;if(this.year<d.year)return false;if(this.month>d.month)return true;if(this.month<d.month)return false;return(this.date>d.date);},isEqual:function(d){return(this.year==d.year&&this.month==d.month&&this.date==d.date);},isLaterOrEqual:function(d){return this.isLater(d)||this.isEqual(d);},getFullYear:function(){return this.year;},myDateFromDate:function(date){this.date=date.getDate();this.month=date.getMonth();if(Prototype.msieBrowser()){this.year=date.getYear();}
else this.year=date.getYear()+1900;},setDateFromISODate:function(date){if(date!==null){var aDate=date.split('-');this.year=parseInt(aDate[0]);this.month=parseInt(aDate[1],10)-1;this.date=parseInt(aDate[2],10);}},dateToString:function(){return""+this.date+"."+(this.month+1)+"."+this.year;},addMonth:function(){this.month++;},addDay:function(){this.date++;}});Widget.Response.DatePicker=Class.define({initialize:function(currentDate,rangeStart,rangeEnd){this.currentDate=currentDate;this.rangeStart=rangeStart;this.rangeEnd=rangeEnd;},getCurrentDate:function(){return this.currentDate;},getRangeStart:function(){return this.rangeStart;},getRangeEnd:function(){return this.rangeEnd;}})