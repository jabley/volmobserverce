
Widget.TimeDisplay=Class.define({initialize:function(id,options,mode){this.initializeTimeDisplay(id,options,mode);},initializeTimeDisplay:function(id,options,mode){this.id=id;this.mode=mode;this.element=$(id);this.locked=true;this.time=new Date();this.timeDiff=0;this.preloadedImages=new Array();this.format=null;this.specialMarks=new Array('Y','y','F','m','D','d','h','H','i','s','A','S')
this.formatArray=null;this.mapping=null;this.digits=null;this.separators=null;this.months=null;this.days=null;this.ampm=null;this.arrayNames=new Array('digits','separators','months','days','ampm');Object.copyFields(this,options||{});var d=new Date();this.sgn=Prototype.nokiaOSSBrowser()?-1:1;this.offset=d.getTimezoneOffset()*60*1000*this.sgn;this.initializeMapping();this.formatArray=this.getFormatArray();if(this.mode=='timer'){this.setMode('timer');}
this.preloadImages();},setMode:function(m){this.mode=m;if(m=='timer'){this.prepareTimerDataAccesMethod();this.arrayNames=new Array('digits','separators');}},getAccuracy:function(){timeMarks=new Array('S','s','i');var min=null;for(var j=0;j<timeMarks.length;j++){for(var i=0;i<this.formatArray.length;i++){if(this.formatArray[i]==timeMarks[j]){min=timeMarks[j];break;}}
if(min!=null){break;}}
switch(min){case'S':min=123;break;case's':min=1000;break;case'i':min=60000;break;default:min=3600000;break;}
return min;},getFormatArray:function(){var ret=new Array();for(var i=0;i<this.format.length;i++){if(this.format[i].charAt(0)=='%'){ret[i]=this.format[i].substr(1);}else{ret[i]=this.addLiteralSeparator(this.format[i]);}}
return ret;},addLiteralSeparator:function(separator){var id=this.separators.length;this.separators[id]=this.separators[id-1]+'0';this.separators[id-1]=separator;return id;},setTimeToDisplay:function(date){if(!this.locked){this.time=date;this.refresh();}},refresh:function(){var map;var dataAccesMethodName='';var dataFormatMethodName='';var markupArray='';var time='';var tmp=null;var key='';for(var i=0;i<this.formatArray.length;i++){tmp=null;key=this.formatArray[i];if(this.isNumber(key)){key=0;}
map=this.mapping[key];if(map!=null){dataAccesMethodName=map[0];dataFormatMethodName=map[1];markupArray=map[2];if(dataAccesMethodName!=null){if(this.mode=='timer'&&key==this.timerPrecision){tmp=this.timerDataAccesMethod();}else{tmp=this.time[dataAccesMethodName]();}}
if(tmp==null){tmp=this.formatArray[i];}
if(dataFormatMethodName!=null){if(this.mode=='timer'&&key==this.timerPrecision){tmp=this.num2Str(tmp);}else{tmp=this[dataFormatMethodName](tmp);}}
if(markupArray!=null){time+=this.stringValueToImages(tmp,markupArray);}}}
this.element.innerHTML=time;},initializeMapping:function(){this.mapping=new Array();this.mapping['Y']=['getFullYear','num2Str','digits'];this.mapping['y']=['getYear','getNumOn2Dig','digits'];this.mapping['F']=['getMonth','num2Str','months'];this.mapping['m']=['getMonth','getIncrementedNumOn2Dig','digits'];this.mapping['D']=['getDay','num2Str','days'];this.mapping['d']=['getDate','getNumOn2Dig','digits'];this.mapping['h']=['getHours','getHour12','digits'];this.mapping['H']=['getHours','getNumOn2Dig','digits'];this.mapping['i']=['getMinutes','getNumOn2Dig','digits'];this.mapping['s']=['getSeconds','getNumOn2Dig','digits'];this.mapping['S']=['getMilliseconds','getNumOn3Dig','digits'];this.mapping['A']=['getHours','getAMorPM','ampm']
this.mapping['0']=[null,'getSepNum','separators'];},prepareTimerDataAccesMethod:function(){var p=this.resolveTimerPrecision();this.divider=1;switch(p){case('s'):this.divider=1000;break;case('i'):this.divider=1000*60;break;case('H'):this.divider=1000*60*60;break;case('d'):this.divider=1000*60*60*24;break;}},calculateMinDigitsCount:function(startTime){this.time=startTime;var t=this.timerDataAccesMethod();if(t>99){this.minDigitsCount=3;}else if(t<99&&t>9){this.minDigitsCount=2;}else{this.minDigitsCount=1;}},timerDataAccesMethod:function(){return parseInt((this.time.getTime()-this.offset)/this.divider);},resolveTimerPrecision:function(){if(this.formatArray.indexOf('d')!=-1)return this.timerPrecision='d';if(this.formatArray.indexOf('H')!=-1)return this.timerPrecision='H';if(this.formatArray.indexOf('i')!=-1)return this.timerPrecision='i';if(this.formatArray.indexOf('s')!=-1)return this.timerPrecision='s';return this.timerPrecision='S';},getSepNum:function(tmp){var ret=null;if(this.isNumber){ret=parseInt(tmp)-1;}
return ret;},getAMorPM:function(hour){var ret;if(hour<13){ret=0;}else{ret=1;}
return ret.toString();},getIncrementedNumOn2Dig:function(number){return this.getNumOn2Dig(number+1);},getHour12:function(hour){if(hour>12){hour-=12;}
return this.getNumOn2Dig(hour);},getNumOn2Dig:function(number){if(number<10){return'0'+number;}else if(number>99){return number.toString().substr(number.toString().length-2);}else{return number.toString()}},getNumOn3Dig:function(number){if(number<10){return'00'+number;}else if(number>9&&number<100){return'0'+number;}else{return number.toString()}},num2Str:function(number){switch(this.minDigitsCount){case 3:return this.getNumOn3Dig(number);case 2:return this.getNumOn2Dig(number);}
return number.toString();},stringValueToImages:function(text,markupArray){var output='';if(markupArray=='digits'){for(var i=0;i<text.length;i++){output+=this.getHTMLcode(this.digits,parseInt(text.charAt(i)));}}else{output+=this.getHTMLcode(this[markupArray],parseInt(text));}
return output;},getHTMLcode:function(array,index){if(array[array.length-1].charAt(index)=='1'){return $W(array[index]);}else{return array[index];}},isNumber:function(value){if(value=="")return false;var d=parseInt(value);return(!isNaN(d));},preloadImages:function(array){var k=0;var tmp='';this.mElement=document.createElement("span")
this.mElement.style.visibility="hidden"
this.mElement.style.padding="0px";this.mElement.style.border="0px";this.mElement.style.margin="0px";for(var i=0;i<this.arrayNames.length;i++){var arr=this[this.arrayNames[i]];for(var j=0;j<arr['length'];j++){if(arr[arr.length-1].charAt(j)=='1'){tmp+=$W(arr[j]);var files=this.getImagesFileNames($W(arr[j]));if(files.length>0){for(var l=0;l<files.length;l++){this.preloadedImages[k]=new Image();this.preloadedImages[k].src=files[l];k++;}}}}}
this.mElement.innerHTML=tmp;document.body.appendChild(this.mElement)
this.mElement.style.display="none"
this.locked=false;},getImagesFileNames:function(string){var ret=new Array();var tmp=string;var ind=0;var stop=false;while(tmp.indexOf("<img")>=0){var i=tmp.indexOf("src");if(i>0){tmp=tmp.substr(i+3);i=tmp.indexOf("\"");if(i>0){tmp=tmp.substr(i+1);i=tmp.indexOf("\"");ret[ind]=tmp.substr(0,i);ind++;tmp=tmp.substr(i+1);}}else{tmp='';}}
return ret;}})
Widget.Clock=Widget.define(Widget.Refreshable,{initialize:function(id,options){this.initializeWidget(id,options)
this.timeDisplay=new Widget.TimeDisplay(id,options,'clock');this.setTimeMethods=['setFullYear','setMonth','setDate','setHours','setMinutes','setSeconds'];this.delay=this.timeDisplay.getAccuracy();this.time=new Date();this.sgn=Prototype.nokiaOSSBrowser()?-1:1;this.usesPolling=false;this.startSync();this.addAction("force-sync");},startSync:function(){if(this.refreshURL!=''){this.startRefresh();this.forceUpdate();}
this.preInterval=setInterval(this.preUpdate.bind(this),1000);this.timeDisplay.setTimeToDisplay(this.time);},preUpdate:function(){switch(this.delay){case 1000:this.startUpdate();break;case 60000:var min=this.time.getMinutes();this.time.setSeconds(this.time.getSeconds()+1);if(min!=this.time.getMinutes()){this.startUpdate();;}
break;case 3600000:var h=this.time.getHours();this.time.setSeconds(this.time.getSeconds()+1);if(h!=this.time.getHours()){this.startUpdate();}
break;}
var timeCurr=new Date();this.timeDiff=this.time.getTime()-timeCurr.getTime();Widget.log("diff2",this.timeDiff)},startUpdate:function(){this.timeDisplay.setTimeToDisplay(this.time);setInterval(this.update.bind(this),this.delay);clearInterval(this.preInterval);},update:function(){var dateTmp=new Date();if(this.refreshURL==""){this.time=dateTmp;}else{this.time.setTime(dateTmp.getTime()+this.timeDiff*this.sgn);}
this.timeDisplay.setTimeToDisplay(this.time);},forceSync:function(){if(this.refreshURL==''){this.update();}else{this.forceUpdate();}},syncLocalTime:function(){this.time=new Date();this.timeDisplay.setTimeToDisplay(this.time);},processAJAXResponse:function(originalRequest){var myObject=eval('('+originalRequest.responseText+')');var dateArray=myObject.date;var tmp=new Date();tmp.setTime(dateArray[6]);var offset=tmp.getTimezoneOffset()*60*1000;this.time.setTime(dateArray[6]+offset*this.sgn);tmp=new Date();this.timeDiff=this.sgn*(this.time.getTime()-tmp.getTime());this.timeDisplay.setTimeToDisplay(this.time);}});Widget.Stopwatch=Widget.define({initialize:function(id,count_mode,splitContainer,options){this.initializeWidget(id,options)
this.splitContainer=splitContainer
this.count_mode=count_mode;this.options=options;this.installOptions(options);this.timeDisplay=new Widget.TimeDisplay(id,options,'timer');this.delay=this.timeDisplay.getAccuracy();var d=new Date();this.sgn=Prototype.nokiaOSSBrowser()?-1:1;this.offset=d.getTimezoneOffset()*60*1000*this.sgn;this.usesPolling=false;this.elapsedTime=new Date(0);this.lapTime=new Date(0);this.savedMS=0;this.displayTime=new Date(0);this.stopped=true;this.paused=false;this.startTime=new Date();this.currentTime=new Date();this.lastLap=new Date();this.addAction('start');this.addAction('stop');this.addAction('reset');this.addAction('split');this.reset();},reset:function(){this.currentTime=new Date();this.stop();this.paused=false;this.savedMS=0;this.displayTime=new Date(this.offset);this.timeDisplay.setTimeToDisplay(this.displayTime);this.splitContainer.setContent(null);},getDisplayTime:function(){this.lastLapMS=this.currentTime.getTime()-this.lastLap.getTime();if(this.count_mode=='lap'){this.displayTime.setTime(this.lastLapMS+this.offset);}else{this.displayTime.setTime(this.lastLapMS+this.savedMS+this.offset);}
return this.displayTime;},getDisplaySummaryTime:function(){this.lastLapMS=this.currentTime.getTime()-this.lastLap.getTime();this.displayTime.setTime(this.lastLapMS+this.savedMS+this.offset);return this.displayTime;},start:function(){this.currentTime=new Date();if(this.stopped){this.stopped=false;if(!this.paused){this.startTime.setTime(this.currentTime.getTime());this.lastLap.setTime(this.currentTime.getTime());}else{this.lastLap.setTime(this.currentTime.getTime()-this.lastLapMS);this.paused=false;}
this.preInterval=setInterval(this.preUpdate.bind(this),75);this.timeDisplay.setTimeToDisplay(this.getDisplayTime());}},stop:function(){this.currentTime=new Date();if(!this.stopped){this.stopped=true;this.paused=true;this.timeDisplay.setTimeToDisplay(this.getDisplaySummaryTime());clearInterval(this.interval);}},split:function(){if(!this.stopped||this.paused){this.currentTime=new Date();(this.count_mode=='lap')?this.doLap():this.doSplit();}},doSplit:function(){var content=new Widget.Internal.BlockContent(null,"<div></div>");this.splitContainer.addLast(content)
var d=new Widget.TimeDisplay(content.getElement(),this.options,'timer');d.setTimeToDisplay(this.displayTime);},doLap:function(){var content=new Widget.Internal.BlockContent(null,"<div></div>");this.splitContainer.addLast(content)
var d=new Widget.TimeDisplay(content.getElement(),this.options,'timer');if(!this.stopped){this.lastLapMS=this.currentTime.getTime()-this.lastLap.getTime();this.lastLap.setTime(this.currentTime.getTime());this.lapTime.setTime(this.lastLapMS+this.offset);this.savedMS+=this.lastLapMS;}else{this.lapTime.setTime(this.lastLapMS+this.offset);this.savedMS+=this.lastLapMS;this.lastLapMS=0;}
d.setTimeToDisplay(this.lapTime);},preUpdate:function(){this.startUpdate();},startUpdate:function(){this.timeDisplay.setTimeToDisplay(this.getDisplayTime());this.interval=setInterval(this.update.bind(this),this.delay);clearInterval(this.preInterval);},update:function(){this.currentTime=new Date();this.timeDisplay.setTimeToDisplay(this.getDisplayTime());}});Widget.Timer=Widget.define({initialize:function(id,options){this.initializeWidget(id,options)
this.start_time=null;this.stop_time=null;this.load_src=null;this.installOptions(options);this.startTime=this.start_time;this.stopTime=this.stop_time;this.timeDisplay=new Widget.TimeDisplay(id,options,'timer');var d=new Date(0);this.sgn=Prototype.nokiaOSSBrowser()?-1:1;this.offset=d.getTimezoneOffset()*60*1000*this.sgn;this.delay=this.timeDisplay.getAccuracy();this.usesPolling=false;this.elapsedTime=new Date(0);this.stopped=true;if(this.load_src==null){this.startMS=parseInt(this.startTime);this.initialStartMS=parseInt(this.startTime);this.stopMS=parseInt(this.stopTime);}else{this.loadConfiguration();}
this.addAction('start');this.addAction('stop');this.addAction('reset');this.addEvent('finished');this.addProperty('start-time',{type:"int"});this.addProperty('stop-time',{type:"int"});this.displayTime=new Date(this.offset);this.reset();},loadConfiguration:function(){new Widget.AjaxRequest(this.load_src,{method:"get",onSuccess:this.configurationLoaded.bind(this)})},configurationLoaded:function(request){var myObject=eval('('+request.responseText+')');this.startMS=parseInt(myObject.start);this.stopMS=parseInt(myObject.stop);this.initialStartMS=this.startMS;this.reset();},reset:function(){clearInterval(this.interval);this.stopped=true;this.finished=false;var s=this.initialStartMS+this.offset
this.displayTime.setTime(this.initialStartMS+this.offset);this.elapsedMS=0;this.startMS=this.initialStartMS;this.timeDisplay.calculateMinDigitsCount(this.displayTime)
this.timeDisplay.setTimeToDisplay(this.displayTime);},getDisplayTime:function(){this.currentTime=new Date();this.elapsedMS=this.currentTime.getTime()-this.startTime.getTime();this.displayMS=this.startMS-this.elapsedMS;this.displayTime.setTime(this.displayMS+this.offset);return this.displayTime;},start:function(){if(this.stopped&&!this.finished&&this.startMS>0){this.stopped=false;this.startTime=new Date();this.currentTime=new Date();this.preInterval=setInterval(this.preUpdate.bind(this),123);this.timeDisplay.setTimeToDisplay(this.getDisplayTime());}},stop:function(){if(!this.stopped){this.stopped=true;this.timeDisplay.setTimeToDisplay(this.getDisplayTime());this.startMS=this.startMS-this.elapsedMS;clearInterval(this.interval);}},preUpdate:function(){this.startUpdate();},startUpdate:function(){this.timeDisplay.setTimeToDisplay(this.getDisplayTime());this.interval=setInterval(this.update.bind(this),this.delay);clearInterval(this.preInterval);},update:function(){this.getDisplayTime();var i=this.displayTime.getTime()-this.offset;if(i<=this.stopMS){clearInterval(this.interval);this.stopped=true;this.finished=true;this.displayTime.setTime(this.offset+this.stopMS);this.timeDisplay.setTimeToDisplay(this.displayTime);this.notifyObservers('finished');}else{this.timeDisplay.setTimeToDisplay(this.displayTime);}},setStartTime:function(time){if(time!=null&&time!=this.startTime&&time>=0){this.startTime=time;this.notifyObservers("startTimeChanged");this.startMS=parseInt(this.startTime);this.initialStartMS=parseInt(this.startTime);this.reset();}},setStopTime:function(time){if(time!=null&&time!=this.stopTime&&time>=0){this.stopTime=time;this.notifyObservers("stopTimeChanged");this.stopMS=parseInt(this.stopTime);this.reset();}},getStartTime:function(){return this.startTime;},getStopTime:function(){return this.stopTime;}});