
Widget.DynamicMenu=Class.create();Object.extend(Widget.DynamicMenu.prototype,Widget.Appearable);Object.extend(Widget.DynamicMenu.prototype,Widget.Disappearable);Object.extend(Widget.DynamicMenu.prototype,{FOLDED:1,UNFOLDED:2,initialize:function(id,options){this.id=id;this.element=$(id);this.activeLevel=1;this.activeBranch=this.id;this.focusInMenu=true;this.dir='ltr';this._semaphore=0;this.aActiveMenus=new Array();Object.copyFields(this,options||{});this.prepareMenu(this.element);this.clearSpareDivs(this.element);this.addLevels(this.element);this.setMainOrientation();this.addObservers(this.element);},addObservers:function(element){var node,outerDiv,innerDiv;var typeEvent='focus';var targetOfEvent;if(element.getAttribute('vfc-openEvent')!=undefined){typeEvent=element.getAttribute('vfc-openEvent');}
innerDiv=element.lastChild.firstChild;for(var k=0;k<innerDiv.childNodes.length;k++){node=innerDiv.childNodes[k];if(node.firstChild.nodeName=='DIV'&&node.getAttribute('vfc-orientation')!=undefined){targetOfEvent=node.firstChild.firstChild;if(typeEvent=='click'){Widget.addElementObserver(targetOfEvent,Widget.CLICK,this.showSubMenu.bindAsEventListener(this));Widget.addElementObserver(targetOfEvent,Widget.FOCUS,this.setFocusInMenu.bindAsEventListener(this));}else{Widget.addElementObserver(targetOfEvent,Widget.FOCUS,this.showSubMenu.bindAsEventListener(this));}
Widget.addElementObserver(targetOfEvent,Widget.BLUR,this.blurHandler.bindAsEventListener(this));this.addObservers(node);}else{if(typeEvent=='focus'){Widget.addObserversToFocusableElements(node,Widget.FOCUS,this.focusLinkHandler.bindAsEventListener(this));Widget.addObserversToFocusableElements(node,Widget.BLUR,this.blurHandler.bindAsEventListener(this));}
Widget.addObserversToFocusableElements(node,Widget.CLICK,this.foldAllDynamicMenu.bindAsEventListener(this));}}
return;},setMainOrientation:function(){var menuDiv=$(this.id);var menuWidth,dim,itemLeftPoz=0,maxHeight=0,itemTopPoz=0,maxWidth=0;maxTextWidth=0;var maxItemMargin=0;var orientation=menuDiv.getAttribute('vfc-orientation');var innerDiv=menuDiv.lastChild.firstChild;var itemDiv=null;var maxPaddingBorder=0;for(var i=0;i<innerDiv.childNodes.length;i++){itemDiv=innerDiv.childNodes[i];var submenuLabelDiv=null;if(itemDiv.getAttribute('vfc-orientation')){submenuLabelDiv=itemDiv.firstChild;if(submenuLabelDiv.getStyle('border-bottom-width')!='0px'||submenuLabelDiv.getStyle('padding-bottom')!='0px'){submenuLabelDiv=Element.extend(submenuLabelDiv);var menuLineHeight=submenuLabelDiv.offsetHeight;submenuLabelDiv.vfcReplaceStyle({'border-bottom-width':'0px','padding-bottom':'0px'});var maxItemPaddingBorder=menuLineHeight-submenuLabelDiv.offsetHeight;if(maxItemPaddingBorder>maxPaddingBorder){maxPaddingBorder=maxItemPaddingBorder;}
submenuLabelDiv.vfcRevertStyle();}}
if(orientation=='horizontal'){itemDiv.style.display='inline';if(submenuLabelDiv!=null){submenuLabelDiv.style.display='inline';}}else{itemDiv.style.width='auto';}}
innerDiv.style.position='absolute';if(orientation=='horizontal'){menuDiv.style.height=innerDiv.offsetHeight+(maxPaddingBorder*2)+'px';}else{menuDiv.style.height=innerDiv.offsetHeight+'px';}
menuDiv.bottomPaddingBorderWidth=maxPaddingBorder;},setSubOrientation:function(menuDiv){var menuWidth,dim,itemLeftPoz=0,itemDiv,maxHeight=0,itemTopPoz=0,maxWidth=0,maxTextWidth=0;var parentMenuDiv=menuDiv.parentNode.parentNode.parentNode;var parentOrientation=parentMenuDiv.getAttribute('vfc-orientation');var parentLevel=parentMenuDiv.getAttribute('level');var orientation=menuDiv.getAttribute('vfc-orientation');var innerDiv=menuDiv.lastChild.firstChild;var outerDiv=menuDiv.lastChild;var labelDiv=menuDiv.firstChild;outerDiv.style.visibility='hidden';outerDiv.style.display='block';outerDiv.style.position='absolute';var maxPaddingBorder=0;for(var i=0;i<innerDiv.childNodes.length;i++){itemDiv=innerDiv.childNodes[i];var submenuLabelDiv=Element.extend(itemDiv.firstChild);if(orientation=='horizontal'){itemDiv.style.display='inline';}
var submenuLabelDiv=null;if(itemDiv.getAttribute('vfc-orientation')){submenuLabelDiv=Element.extend(itemDiv.firstChild);submenuLabelDiv.style.display='inline';if(submenuLabelDiv.getStyle('border-bottom-width')!='0px'||submenuLabelDiv.getStyle('padding-bottom')!='0px'){var menuLineHeight=submenuLabelDiv.offsetHeight;submenuLabelDiv.vfcReplaceStyle({'border-bottom-width':'0px','padding-bottom':'0px'});var maxItemPaddingBorder=menuLineHeight-submenuLabelDiv.offsetHeight;if(maxItemPaddingBorder>maxPaddingBorder){maxPaddingBorder=maxItemPaddingBorder;}
submenuLabelDiv.vfcRevertStyle();}}}
menuDiv.bottomPaddingBorderWidth=maxPaddingBorder;if(orientation=='horizontal'){if(parentOrientation=='vertical'){outerDiv.style.top=menuDiv.offsetTop+parentMenuDiv.bottomPaddingBorderWidth+'px';outerDiv.style.left=labelDiv.offsetWidth+'px';}else{outerDiv.style.top=labelDiv.offsetHeight-parentMenuDiv.bottomPaddingBorderWidth+'px';outerDiv.style.left=labelDiv.offsetLeft+'px';}
if(Prototype.firefoxBrowser()){outerDiv.style.width=outerDiv.offsetWidth+'px';}}
if(orientation=='vertical'){if(parentOrientation=='horizontal'){outerDiv.style.top=menuDiv.offsetHeight+parentMenuDiv.bottomPaddingBorderWidth+'px';outerDiv.style.left=menuDiv.offsetLeft+'px';}else{outerDiv.style.top=menuDiv.offsetTop+parentMenuDiv.bottomPaddingBorderWidth+'px';outerDiv.style.left=menuDiv.offsetLeft+labelDiv.offsetWidth+'px';}
if(parentOrientation=='vertical'){var dim=Position.cumulativeOffset(outerDiv);var screenWidth=document.body.clientWidth;var lackRightScreen=dim[0]+maxWidth-screenWidth;var overlayRight=(lackRightScreen/outerDiv.parentNode.offsetWidth)*100;if(lackRightScreen>0){if(overlayRight<25){outerDiv.style.left=(outerDiv.parentNode.offsetWidth-lackRightScreen)+'px';}else{dim=Position.cumulativeOffset(outerDiv.parentNode);var lackLeftScreen=dim[0]-maxWidth;var overlayLeft=(lackLeftScreen/outerDiv.parentNode.offsetWidth)*100;if(lackLeftScreen>0){outerDiv.style.left=(-maxWidth)+'px';}else{if((overlayRight-overlayLeft)<25){}else{outerDiv.style.left=(-(maxWidth+lackLeftScreen))+'px';}}}}}}
outerDiv.style.visibility='visible';outerDiv.style.display='none';},showSubMenu:function(evt){if(this._semaphore==1){return;}
var labelDiv,outerDiv;var sourceOfEvent;if(Prototype.nokiaOSSBrowser()){sourceOfEvent=Event.element(evt).parentNode;if(sourceOfEvent.nodeName!='A'){sourceOfEvent=sourceOfEvent.parentNode;}}else{sourceOfEvent=Event.element(evt);}
labelDiv=sourceOfEvent.parentNode;outerDiv=labelDiv.nextSibling;menuDiv=sourceOfEvent.parentNode.parentNode;if(this.triggeredByFocus(evt.type)){this.focusInMenu=true;var aActiveMenusOld=new Array();this.aActiveMenus.each(function(menu){aActiveMenusOld.push(menu);});this.aActiveMenus.clear();this.setActiveBranch(menuDiv);this.foldOldBranch(aActiveMenusOld);}
this.activeLevel=menuDiv.getAttribute('level');if(Element.getStyle(outerDiv,'display')!='none'&&evt.type=='click'){this.hideChildSubmenus(menuDiv);return;}
if(outerDiv.style.display=='none'){var unfoldedStyle=labelDiv.getAttribute('vfc-unfoldedstyle');if(unfoldedStyle){labelDiv=Element.extend(labelDiv);labelDiv.vfcReplaceStyle(this.string2Object(unfoldedStyle));}
this.setUnfoldedMarker(labelDiv);this.setSubOrientation(labelDiv.parentNode);Element.setStyle(menuDiv,{zIndex:menuDiv.getAttribute("level")+1});var id=this.id;var it=this;Widget.TransitionFactory.createAppearEffect(outerDiv,this,{afterFinish:function(effect){it._semaphore=0;}});this._semaphore=1;}},foldOldBranch:function(aActiveMenusOld){if(this._semaphore==1){return;}
var parentMenuDiv;for(var i=0;i<aActiveMenusOld.length;i++){if(aActiveMenusOld[i]==''){continue;}
var toFolding=true;for(var j=0;j<this.aActiveMenus.length;j++){if(aActiveMenusOld[i]==this.aActiveMenus[j]){toFolding=false;}}
if(toFolding){var outerDiv=$(aActiveMenusOld[i]).lastChild;var labelDiv=$(aActiveMenusOld[i]).firstChild;parentMenuDiv=$(aActiveMenusOld[i]).parentNode.parentNode.parentNode;if(parentMenuDiv.getAttribute('vfc-openEvent')=='click'){continue;}
Element.setStyle($(aActiveMenusOld[i]),{zIndex:$(aActiveMenusOld[i]).getAttribute("level")});var id=this.id;var it=this;Widget.TransitionFactory.createDisappearEffect(outerDiv,this,{afterFinish:function(effect){Widget.getInstance(id).setFoldedMarker(labelDiv);labelDiv.vfcRevertStyle();it._semaphore=0;}});this._semaphore=1;}}
return;},setActiveBranch:function(menuDiv){var parentMenuDiv;var divNode;parentMenuDiv=menuDiv.parentNode.parentNode.parentNode;if(parentMenuDiv.getAttribute('id')==this.id){this.aActiveMenus.push(menuDiv.getAttribute('id'));return;}else{this.aActiveMenus.push(menuDiv.getAttribute('id'));this.setActiveBranch(parentMenuDiv);return;}},_initMarker:function(markerElement){var display=markerElement.getStyle('display');if(Prototype.nokiaOSSBrowser()&&display===null){markerElement._status=this.UNFOLDED;}else if(display=='none'){markerElement._status=this.UNFOLDED;}else if(display=='inline'){markerElement._status=this.FOLDED;}},setFoldedMarker:function(element){markers=element.getElementsByTagName("SPAN");for(var i=0;i<markers.length;i++){var markerEl=$(markers[i]);if(!markerEl._status){this._initMarker(markerEl);}
if(markerEl._status==this.FOLDED){markerEl.style.display='inline';}
if(markerEl._status==this.UNFOLDED){markerEl.style.display='none';}}},setUnfoldedMarker:function(element){markers=element.getElementsByTagName("SPAN");for(var i=0;i<markers.length;i++){var markerEl=$(markers[i]);if(!markerEl._status){this._initMarker(markerEl);}
if(markerEl._status==this.FOLDED){markerEl.style.display='none';}
if(markerEl._status==this.UNFOLDED){markerEl.style.display='inline';}}},focusLinkHandler:function(evt){var sourceOfEvent,eventLevel,eventBranch;this.focusInMenu=true;if(Prototype.nokiaOSSBrowser()){sourceOfEvent=Event.element(evt).parentNode;if(sourceOfEvent.nodeName!='A'){sourceOfEvent=sourceOfEvent.parentNode;}}else{sourceOfEvent=Event.element(evt);}
var menuDiv=this.findMenuDiv(sourceOfEvent);var aActiveMenusOld=new Array();this.aActiveMenus.each(function(menu){aActiveMenusOld.push(menu);});this.aActiveMenus.clear();if(menuDiv!=this.element){this.setActiveBranch(menuDiv);}
this.foldOldBranch(aActiveMenusOld);},findMenuDiv:function(element){element=$(element);while(element=element.parentNode){if(element.getAttribute('vfc-orientation')!=undefined){return element;}}},blurHandler:function(){this.focusInMenu=false;window.setTimeout("Widget.getInstance('"+this.id+"').checkFocusInMenu()",200);},checkFocusInMenu:function(){if(this.focusInMenu==false){this.foldMenu(this.element,false);}},setFocusInMenu:function(){this.focusInMenu=true;},foldAllDynamicMenu:function(){this.foldMenu(this.element,true);},foldMenu:function(menuDiv,allSubmenu){if(this._semaphore==1){return;}
var node,parentMenuDiv;var innerDiv=menuDiv.lastChild.firstChild;var outerDiv=menuDiv.lastChild;var labelDiv=menuDiv.firstChild;if(menuDiv!=this.element){parentMenuDiv=menuDiv.parentNode.parentNode.parentNode;}
for(var i=0;i<innerDiv.childNodes.length;i++){node=innerDiv.childNodes[i];if(node.getAttribute('vfc-orientation')){this.foldMenu(node,allSubmenu);}}
if(menuDiv.getAttribute('level')>1){if(!allSubmenu&&parentMenuDiv.getAttribute('vfc-openEvent')=='click'){return;}
Element.setStyle(menuDiv,{zIndex:menuDiv.getAttribute("level")});if(outerDiv.style.display!='none'){var id=this.id;var it=this;Widget.TransitionFactory.createDisappearEffect(outerDiv,this,{afterFinish:function(effect){Widget.getInstance(id).setFoldedMarker(labelDiv);labelDiv.vfcRevertStyle();it._semaphore=0;}});this._semaphore=1;}}
return;},hideLevelSubmenu:function(menuDiv,level){var node;var innerDiv=menuDiv.lastChild.firstChild;var labelDiv=menuDiv.firstChild;for(var i=0;i<innerDiv.childNodes.length;i++){node=innerDiv.childNodes[i];if(node.firstChild.nodeName=='DIV'&&node.getAttribute('vfc-orientation')!=undefined){if(Element.getStyle(node.lastChild,'display')!='none'&&node.getAttribute('level')>level){this.hideChildSubmenus(node);}}}
return;},hideChildSubmenus:function(element){if(this._semaphore==1){return;}
var node,labelDiv,outerDiv;var innerDiv=element.lastChild.firstChild;outerDiv=element.lastChild;labelDiv=Element.extend(element.firstChild);for(var i=0;i<innerDiv.childNodes.length;i++){node=innerDiv.childNodes[i];if(node.firstChild.nodeName=='DIV'&&node.getAttribute('vfc-orientation')!=undefined){this.hideChildSubmenus(node);}}
Element.setStyle(element,{zIndex:element.getAttribute("level")});if(Element.getStyle(outerDiv,'display')!='none'){var id=this.id;var it=this;Widget.TransitionFactory.createDisappearEffect(outerDiv,this,{afterFinish:function(effect){Widget.getInstance(id).setFoldedMarker(labelDiv);labelDiv.vfcRevertStyle();it._semaphore=0;}});this._semaphore=1;}
return;},hideBranchSubmenus:function(element){if(this._semaphore==1){return;}
var node,labelDiv;var innerDiv=element.lastChild.firstChild;labelDiv=element.firstChild;for(var i=0;i<innerDiv.childNodes.length;i++){node=innerDiv.childNodes[i];if(node.firstChild.nodeName=='DIV'&&node.getAttribute('vfc-orientation')!=undefined){this.hideBranchSubmenus(node);}}
var outerDiv=element.lastChild;Element.setStyle(element,{zIndex:element.getAttribute("level")});if(Element.getStyle(outerDiv,'display')!='none'){var id=this.id;var it=this;Widget.TransitionFactory.createDisappearEffect(outerDiv,this,{afterFinish:function(effect){Widget.getInstance(id).setFoldedMarker(labelDiv);labelDiv.vfcRevertStyle();it._semaphore=0;}});this._semaphore=1;}
return;},prepareMenu:function(element){var node;Element.cleanWhitespace(element);for(var k=0;k<element.childNodes.length;k++){node=element.childNodes[k];this.prepareMenu(node);}
return;},clearSpareDivs:function(element){var node;for(var k=0;k<element.childNodes.length;k++){node=element.childNodes[k];if(node.firstChild)
{if(element.nodeName=='DIV'&&node.firstChild.nodeName=='DIV'){if(node.firstChild.getAttribute("vfc-orientation")){var tmp=node.firstChild;node.parentNode.replaceChild(tmp,node);node=tmp;}
this.clearSpareDivs(node);}}}
return;},addLevels:function(id){var node,node2;$(id).setAttribute('level',this.activeLevel);$(id).firstChild.setAttribute('level',this.activeLevel);$(id).lastChild.setAttribute('level',this.activeLevel);Element.setStyle($(id),{zIndex:this.activeLevel});Element.setStyle($(id).firstChild,{zIndex:this.activeLevel});Element.setStyle($(id).lastChild,{zIndex:this.activeLevel});node=$(id).lastChild.firstChild;node.setAttribute('level',this.activeLevel);if(this.activeLevel>1){Element.setStyle(node,{zIndex:this.activeLevel});}
for(var i=0;i<node.childNodes.length;i++){node2=node.childNodes[i];node2.setAttribute('level',this.activeLevel);Element.setStyle(node2,{zIndex:this.activeLevel});if(node2.firstChild.nodeName=='DIV'&&node2.getAttribute('vfc-orientation')!=undefined){this.activeLevel++;this.addLevels(node2.getAttribute('id'));}}
this.activeLevel--;return;},string2Object:function(string){eval("var result = "+string);return result;},triggeredByFocus:function(eventType){if(eventType==Widget.FOCUS){return true;}
if(Prototype.nokiaOSSBrowser()&&(eventType==Widget.MOUSEOVER)){return true;}
return false;}});