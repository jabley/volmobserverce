
var Ticker={offlineMode:false,requestingFeedPoller:null,getRequestingFeedPoller:function(){return this.requestingFeedPoller;},createFeedPoller:function(options){if(!this.feedPoller){this.feedPoller=new Ticker.FeedPoller(options);}},getFeedPoller:function(){return this.feedPoller;},getItemStorage:function(){var feedPoller=this.getFeedPoller();if(feedPoller){return feedPoller.getStorage();}},getItemStorageStats:function(){if(!this.itemStorageStats){var itemStorage=this.getItemStorage();if(itemStorage){this.itemStorageStats=new Ticker.ItemStorageStats(itemStorage);}}
return this.itemStorageStats;},createTickerTapeController:function(options){options.itemStorage=this.getItemStorage();return new Ticker.TickerTapeController(options);},createCarouselController:function(options){options.itemStorage=this.getItemStorage();return new Ticker.CarouselController(options);},createUpdateStatus:function(options){options.feedPoller=this.getFeedPoller();return new Ticker.UpdateStatus(options);},createItemsCount:function(options){options.storageStats=this.getItemStorageStats();return new Ticker.ItemsCount(options);},createChannelsCount:function(options){options.storageStats=this.getItemStorageStats();return new Ticker.ChannelsCount(options);},createItemProperty:function(options){return new Ticker.ItemProperty(options);},createItemDisplay:function(options){return new Ticker.ItemDisplay(options);}};Ticker.Item=Class.define(Widget.OptionsContainer,Widget.CallbackMixin,{id:null,channel:"",title:"",icon:"",description:"",plainDescription:"",read:false,followed:false,initialize:function(options){this.installOptions(options);this.callbackHandler=new Widget.CallbackHandler();},getId:function(){return this.id;},getChannel:function(){return this.channel;},getTitle:function(){return this.title;},getTitleElement:function(){if(!this.titleElement){this.titleElement=document.createElement("span");this.titleElement.innerHTML=this.title;}
return this.titleElement;},getIcon:function(){return this.icon;},getIconElement:function(){if(this.iconElement===undefined){if(!this.icon){this.iconElement=null;}else{this.iconElement=document.createElement("span");this.iconElement.innerHTML=this.icon;}}
return this.iconElement;},getDescription:function(){return this.description;},getDescriptionElement:function(){if(this.descriptionElement===undefined){if(!this.description){this.descriptionElement=null;}else{this.descriptionElement=document.createElement("div");this.descriptionElement.innerHTML=this.description;}}
return this.descriptionElement;},getPlainDescription:function(){return this.plainDescription;},getPlainDescriptionElement:function(){if(this.plainDescriptionElement===undefined){if(!this.plainDescription){this.plainDescriptionElement=null;}else{this.plainDescriptionElement=document.createElement("span");this.plainDescriptionElement.innerHTML=this.plainDescription;}}
return this.plainDescriptionElement;},isRead:function(){return this.read;},setRead:function(read){Widget.log("Item","["+this.id+"] setting read: "+read);this.read=read;this.callbackHandler.invoke(this);},isFollowed:function(){return this.followed;},setFollowed:function(followed){Widget.log("Item","["+this.id+"] setting followed: "+followed);this.followed=followed;this.callbackHandler.invoke(this);},filter:function(channel,read,followed){return((channel===undefined)||(channel===null)||(this.channel==channel))&&((read===undefined)||(read===null)||(this.read==read))&&((followed===undefined)||(followed===null)||(this.followed==followed));}});Ticker.ItemStorage=Class.define(Widget.CallbackMixin,{initialize:function(){this.items=new Array();this.zombies={};this.callbackHandler=new Widget.CallbackHandler();this.updated=false;},addItem:function(item){this.updated=true;if(this.getItem(item)){return false;}else{Widget.log("ItemStorage","Adding item: "+item.getId());this.items.splice(0,0,item);this.callbackHandler.invoke('add',item);return true;}},removeItem:function(itemToRemove){var index=this.getItemIndex(itemToRemove);if(index>=0){var item=this.items[index];Widget.log("ItemStorage","Removing item: "+item.getId());this.zombies[item.getId()]=item;this.items.splice(index,1);this.callbackHandler.invoke('remove',item);}
return index>=0;},getItems:function(channel,read,followed){var items;for(var i=0;i<this.items.length;i++){var item=this.items[i];if(item.filter(channel,read,followed)){if(items){items.push(item);}}else{if(!items){items=this.items.slice(0,i);}}}
return items||this.items;},getItem:function(id){var index=this.getItemIndex(id);var item=null;if(index>=0){item=this.items[index];}
return item;},getItemIncludingZombies:function(id){var item=this.getItem(id);if(!item){item=this.zombies[id];}
return item;},getItemIndex:function(itemOrId){var itemId=(typeof(itemOrId)=='object'?itemOrId.getId():itemOrId);for(var i=0;i<this.items.length;i++){if(itemId==this.items[i].getId()){return i;}}},isUpdated:function(){return this.updated;}});Ticker.ItemStorageStats=new Class.define(Widget.CallbackMixin,{initialize:function(storage){this.storage=storage;this.storage.addCallback(this.storageChanged.bind(this));this.itemChangedCallback=this.itemChanged.bind(this);var items=this.storage.getItems();for(var i=0;i<items.length;i++){items[i].addCallback(this.itemChangedCallback);}
this.callbackHandler=new Widget.CallbackHandler();},getStorage:function(){return this.storage;},storageChanged:function(operation,item){if(operation=='add'){item.addCallback(this.itemChangedCallback);}else if(operation=='remove'){item.removeCallback(this.itemChangedCallback);}
this.updateStats();},itemChanged:function(){this.updateStats();},updateStats:function(){Widget.log("ItemStorageStats","Stats changed");this.callbackHandler.invoke();},countItems:function(channel,read,followed){var items=this.storage.getItems();var count=0;for(var i=0;i<items.length;i++){if(items[i].filter(channel,read,followed)){count++;}}
return count;},countChannels:function(read,followed){var items=this.storage.getItems();var channels={};var count=0;for(var i=0;i<items.length;i++){item=items[i];if(item.filter(null,read,followed)){channel=item.getChannel();if(!channels[channel]){channels[channel]='dummy';count++;}}}
return count;}});Ticker.FeedPoller=Class.define(Widget.OptionsContainer,Widget.CallbackMixin,{storage:null,url:null,newURL:null,minPollingInterval:null,maxPollingInterval:null,status:'normal',firstRequestSucceeded:false,redirecting:false,initialize:function(options){this.installOptions(options);this.pollingInterval=this.checkPollingInterval(this.getOption('pollingInterval'));if(!this.storage){this.storage=new Ticker.ItemStorage();}
if(!Ticker.offlineMode){this.request=new Ticker.FeedPollerRequest(this);}else{this.request=new Ticker.FeedPollerRequestStub(this);}
this.callbackHandler=new Widget.CallbackHandler();this.duringTimedUpdate=false;this.resume(true);Widget.addPollingEnabledCallback(this.pollingEnabledChanged.bind(this));},pollingEnabledChanged:function(enabled){if(this.getStatus()=='suspended'){this.suspend();}else{this.resume(true);}
this.callbackHandler.invoke();},getStorage:function(){return this.storage;},timedUpdate:function(){this.timer=null;if(!this.duringSkipTimes()){this.duringTimedUpdate=true;this.update();}else{Widget.log("FeedPoller","Skipping request because of skip times");this.setStatus('suspended');this.scheduleUpdate();}},update:function(){if(this.getStatus()!="suspended"){Widget.log("FeedPoller","Sending request: "+this.getRequestURL());Ticker.requestingFeedPoller=this;this.setStatus('busy');this.request.send();}},setStatus:function(status){this.status=status;this.callbackHandler.invoke();},getStatus:function(){return Widget.isPollingEnabled()?this.status:"suspended";},setURL:function(url){Widget.log("FeedPoller","Redirectring: "+url);this.newURL=url;this.newURLFailures=0;this.redirecting=true;},suspend:function(){if(this.timer){clearInterval(this.timer);delete this.timer;}},resume:function(requestImmediately){if(!this.timer){if(requestImmediately){this.timedUpdate();}else{this.scheduleUpdate();}}},scheduleUpdate:function(){Widget.log("FeedPoller","Scheduling request in: "+this.pollingInterval+" seconds");this.timer=setTimeout(this.timedUpdate.bind(this),this.pollingInterval*1000);},setPollingInterval:function(interval){interval=this.checkPollingInterval(interval);Widget.log("FeedPoller","Updating polling interval to "+interval+" seconds");this.pollingInterval=interval;},checkPollingInterval:function(interval){interval=(!interval)?60:interval;interval=this.minPollingInterval?Math.max(interval,this.minPollingInterval):interval;interval=this.maxPollingInterval?Math.min(interval,this.maxPollingInterval):interval;return interval;},setSkipTimes:function(skipTimes){this.skipTimes=skipTimes;},getCurrentTime:function(){var date=new Date();return date.getHours()*60+date.getMinutes();},duringSkipTimes:function(){if(!this.skipTimes){return;}
var currentTime=this.getCurrentTime();for(var i=0;i<this.skipTimes.length;i++){var skipTime=this.skipTimes[i];var fromTime=skipTime[0];var toTime=skipTime[1];if(fromTime<=toTime){if((currentTime>=fromTime)&&(currentTime<toTime)){return true;}}else{if((currentTime>=fromTime)||(currentTime<toTime)){return true;}}}
return false;},getRequestURL:function(){return this.newURL||this.url;},requestSucceeded:function(){Ticker.requestingFeedPoller=null;if(!this.redirecting||this.storage.isUpdated()){this.firstRequestSucceeded=true;}
this.newURLFailures=0;this.requestFinished();this.setStatus('normal');Widget.log("FeedPoller","Request succeeded");},requestFailed:function(){this.newURLFailures++;if(this.newURLFailures>=3){Widget.log("FeedPoller","Reseting to original URL, because 3 subsequent requests failed");delete this.newURL;delete this.newURLFailures;}
this.requestFinished();this.setStatus('failed');Widget.log("FeedPoller","Request failed");},requestFinished:function(){Ticker.requestingFeedPoller=null;if(this.duringTimedUpdate){this.duringTimedUpdate=false;var resumeImmediately=this.redirecting;this.redirecting=false;setTimeout(this.resume.bind(this,resumeImmediately),0);}},isInitialRequest:function(){return!this.firstRequestSucceeded;}});Ticker.AbstractFeedPollerRequest=Class.define({initializeAbstract:function(feedPoller){this.feedPoller=feedPoller;},send:function(){this.onSuccess();},getURL:function(){return this.feedPoller.getRequestURL();},isInitial:function(){return this.feedPoller.isInitialRequest();},onSuccess:function(){this.feedPoller.requestSucceeded();},onFailure:function(){this.feedPoller.requestFailed();}});Ticker.FeedPollerRequest=Class.define(Ticker.AbstractFeedPollerRequest,{initialize:function(feedPoller){this.initializeAbstract(feedPoller);},send:function(){this.request=this.encodeAJAXRequest();},encodeAJAXRequest:function(){var url=this.getURL();var parameters=this.getURLParameters();if(Widget.isLogEnabled()){Widget.log("FeedPoller","Sending AJAX request. URL: '"+this.feedPoller.getRequestURL()+"', params: '"+parameters+"'");}
return new Widget.AjaxRequest(url,{parameters:parameters,method:"get",onSuccess:this.onAJAXRequestSuccess.bind(this),onFailure:this.onAJAXRequestFailure.bind(this),onException:this.onAJAXRequestFailure.bind(this)});},getURLParameters:function(){if(this.isInitial()){return"";}else{return this.encodeURLParameters();}},encodeURLParameters:function(){return $H({context:this.encodeContext()}).toQueryString();},encodeContext:function(){return this.encodeItemIds(this.feedPoller.getStorage().getItems(null,false,false))+'~'+
this.encodeItemIds(this.feedPoller.getStorage().getItems(null,true,false))+'~'+
this.encodeItemIds(this.feedPoller.getStorage().getItems(null,null,true));},encodeItemIds:function(items){var result="";for(var i=0;i<items.length;i++){var item=items[i];if(i>0){result+=".";}
result+=this.encodeItemId(item);}
return result;},encodeItemId:function(item){return item.getId();},onAJAXRequestSuccess:function(request){Widget.log("FeedPoller","AJAX request succeeded");var response=request.responseText;this.getResponseArea().innerHTML=response.stripScripts();setTimeout(this.evalResponseScripts.bind(this,response),10);},onAJAXRequestFailure:function(){Widget.log("FeedPoller","AJAX request failed");this.onFailure();},evalResponseScripts:function(response){response.evalScripts();this.getResponseArea().innerHTML="";this.onSuccess();},createResponseArea:function(){var responseArea=document.createElement("div");var responseAreaElement=Element.extend(responseArea);responseAreaElement.setStyle({display:'none'});responseAreaElement.setStyle({visibility:'hidden'});document.body.appendChild(responseArea);return responseAreaElement;},getResponseArea:function(){if(!this.responseArea){this.responseArea=this.createResponseArea();}
return this.responseArea;}});Ticker.FeedPollerRequestStub=Class.define(Ticker.AbstractFeedPollerRequest,{initialize:function(feedPoller){this.initializeAbstract(feedPoller);},send:function(){Widget.log("FeedPollerRequestStub","Sending request: "+this.getURL()+(this.isInitial()?"(initial)":""));setTimeout(this.result.bind(this),Math.random()*3000);},result:function(){var canFailOnInitial=false;if((canFailOnInitial||!this.isInitial())&&Math.random()<0.25){this.fail();}else{this.succeed();}},fail:function(){this.onFailure();Widget.log("FeedPollerRequestStub","Request failed");},succeed:function(){if(Math.random()<0.15){this.redirect();}else{this.update();}
this.onSuccess();Widget.log("FeedPollerRequestStub","Request succeeded");},redirect:function(){Widget.log("FeedPollerRequestStub","Redirecting");Ticker.Response.setURL("http://dummy.url/"+Math.random());},update:function(){while(Math.random()<0.25){var item=this.anItem();if(item){Widget.log("FeedPollerRequestStub","Removing item "+item.getId());Ticker.Response.removeItem(item);}}
var firstItem=true;while((this.isInitial()&&firstItem)||Math.random()<(this.isInitial()?0.90:0.25)){var id=Math.random().toString().slice(0,4);Widget.log("FeedPollerRequestStub","Adding item "+id);this.feedPoller.getStorage().addItem(new Ticker.Item({id:id,channel:id[0],title:'Item '+id,icon:'<b>F1</b>',description:'Blah blah blah about: '+id+' <a href="http://www.google.pl">Read more...</a>'}));firstItem=false;}
if(this.isInitial()||(Math.random()<0.5)){var interval=Math.random()*3+3;Widget.log("FeedPollerRequestStub","Setting polling interval "+interval);Ticker.Response.setPollingInterval(interval);}},anItem:function(){var items=this.feedPoller.getStorage().getItems();if(items.length>0){return items[items.length-1];}}});Ticker.Response={addItem:function(options){Widget.log("TickerResponse","Adding item "+options.id);Ticker.getRequestingFeedPoller().getStorage().addItem(new Ticker.Item({id:options.id,channel:options.channel,title:$(options.title).innerHTML,icon:options.icon?$(options.icon).innerHTML:null,description:options.description?$(options.description).innerHTML:null,plainDescription:options.plainDescription?$(options.plainDescription).innerHTML:null}));},removeItem:function(id){Widget.log("TickerResponse","Removing item "+id);var storage=Ticker.getRequestingFeedPoller().getStorage();var item=storage.getItem(id);if(item){storage.removeItem(item);}},setURL:function(url){Widget.log("TickerResponse","Setting URL: "+url);Ticker.getRequestingFeedPoller().setURL(url);},setSkipTimes:function(skipTimes){Widget.log("TickerResponse","Setting skip times: "+skipTimes);Ticker.getRequestingFeedPoller().setSkipTimes(skipTimes);},setPollingInterval:function(interval){Widget.log("TickerResponse","Setting polling interval: "+interval);Ticker.getRequestingFeedPoller().setPollingInterval(interval);},followLink:function(itemId,href){Widget.log("TickerResponse","Following a link ("+itemId+"): "+href);var item=Ticker.getItemStorage().getItem(itemId);if(item){window.open(href);item.setFollowed(true);}}};Ticker.ItemTemplate=Widget.define({initialize:function(inlineContent,properties,options){this.initializeWidget(null,options);this.inlineContent=inlineContent;this.properties=properties;},createElement:function(item){var itemElement=this.inlineContent.clone().getElement();this.injectProperties(item,itemElement);return itemElement;},injectProperties:function(item,element){var id=element.id;if(id){var property=this.properties[id];if(property){this.injectProperty(item,element,property);}
element.id=null;}
var childNodes=element.childNodes;for(var i=0;i<childNodes.length;i++){var node=childNodes[i];if(node.nodeType==1){this.injectProperties(item,node);}}},injectProperty:function(item,element,property){var methodName;if(property=="title"){methodName="getTitleElement";}else if(property=="icon"){methodName="getIconElement";}else if(property=="plainDescription"){methodName="getPlainDescriptionElement";}else{throw"Invalid property: "+property;}
var propertyElement=item[methodName]();if(propertyElement){propertyElement=propertyElement.cloneNode(true);element.appendChild(propertyElement);}}});Ticker.WidgetController=Class.define(Widget.OptionsContainer,Widget.CallbackMixin,{widget:null,itemStorage:null,channel:null,itemDisplayId:null,mostRecentFirst:true,itemTemplate:null,initializeWidgetController:function(options){this.installOptions(options);if(this.itemDisplayId){this.itemDisplayIds=this.itemDisplayId.split(",");}
this.widgetID=Math.random().toString();Widget.register(this.widgetID,this);this.delayedCallbackHandler=new Widget.DelayCallbackHandler(500);this.delayedCallbackHandler.add(this.storageCallback.bind(this));this.itemStorage.addCallback(this.delayedCallbackHandler.invoke.bind(this.delayedCallbackHandler));this.callbackHandler=new Widget.CallbackHandler();this.update();},getWidget:function(){return this.widget;},storageCallback:function(operation,item){this.update();},update:function(){if(!this.itemStorage.isUpdated()){return;}
var itemElements=[];var items=this.itemStorage.getItems(this.channel);for(var i=0;i<items.length;i++){itemElements.push(this.getItemElement(items[i]));}
if(!this.mostRecentFirst){itemElements.reverse();}
this.updateWidget(itemElements);},updateWidget:function(itemContents,itemElements){},getItemIconElement:function(item){var html=item.getIcon();if(html){var element=document.createElement("span");element.innerHTML=html;return element;}},getItemTitleElement:function(item){var html=item.getTitle();var element=document.createElement("span");element.innerHTML=html;return element;},getDefaultItemElement:function(item){var iconElement=this.getItemIconElement(item);var titleElement=this.getItemTitleElement(item);if(!iconElement){return titleElement;}else{var iconElementWithMargin=document.createElement("span");iconElementWithMargin.style.marginRight="0.5em";iconElementWithMargin.appendChild(iconElement);var element=document.createElement("span");element.appendChild(iconElementWithMargin);element.appendChild(titleElement);return element;}},getItemElement:function(item){var element;if(!this.itemTemplate){element=this.getDefaultItemElement(item);}else{element=this.itemTemplate.createElement(item);}
element=$(element);Widget.addElementObserver(element,Widget.CLICK,this.itemClicked.bind(this,item.getId()).bindAsEventListener(this));Widget.makeFocusable(element);return element;},itemClicked:function(id,event){var item=this.itemStorage.getItemIncludingZombies(id);if(item){this.callbackHandler.invoke('click',item);if(this.itemDisplayIds){for(var i=0;i<this.itemDisplayIds.length;i++){var itemDisplayId=this.itemDisplayIds[i];var widget=Widget.getInstance(itemDisplayId);if(widget){widget.setItem(item);if(item){if(widget.show){widget.show();}}else{if(widget.hide){widget.hide();}}
item.setRead(true);}}}}}});Ticker.TickerTapeController=Class.define(Ticker.WidgetController,{separatorId:null,firstWidgetUpdate:true,initialize:function(options){Widget.log("TickerTapeController","Initializing...");options.widget=options.widget?options.widget:options.tickerTape;this.initializeWidgetController(options);},updateWidget:function(itemElements){var element=document.createElement("span");for(var i=0;i<itemElements.length;i++){var itemElement=itemElements[i];if(i>0){element.appendChild(this.getSeparatorElement());}
element.appendChild(itemElement);}
if(this.firstWidgetUpdate){Widget.log("TickerTapeController","Setting content immediately");this.getWidget().setContentElementNow(element);}else{Widget.log("TickerTapeController","Setting content");this.getWidget().setContentElement(element);}
if(itemElements.length!=0){this.firstWidgetUpdate=false;}},getSeparator:function(){var separator=" ";if(this.separatorId){separator=$(this.separatorId).innerHTML;}
return separator;},getSeparatorElement:function(){var html=this.getSeparator();var element=document.createElement("span");element.innerHTML=html;return element;}});Ticker.CarouselController=Class.define(Ticker.WidgetController,{firstWidgetUpdate:true,initialize:function(options){Widget.log("CarouselController","Initializing...");options.widget=options.widget?options.widget:options.carousel;this.initializeWidgetController(options);},updateWidget:function(itemElements){if(this.firstWidgetUpdate){Widget.log("CarouselController","Setting content immediately");this.getWidget().setContentElementsNow(itemElements);}else{Widget.log("CarouselController","Setting content");this.getWidget().setContentElements(itemElements);}
if(itemElements.length!=0){this.firstWidgetUpdate=false;}}});Ticker.UpdateStatus=Class.define(Widget.OptionsContainer,{feedPoller:null,normalId:null,busyId:null,failedId:null,suspendedId:null,displayStyle:'inline',initialize:function(options){this.installOptions(options);this.normal=$(this.normalId);this.busy=$(this.busyId);this.failed=$(this.failedId);this.suspended=$(this.suspendedId);this.normal.style.display='none';this.busy.style.display='none';this.failed.style.display='none';this.suspended.style.display='none';this.feedPoller.addCallback(this.update.bind(this));this.update();},update:function(){this.normal.style.display='none';this.busy.style.display='none';this.failed.style.display='none';this.suspended.style.display='none';this.getStatusElement(this.feedPoller.getStatus()).style.display=this.displayStyle;},getStatusElement:function(status){return this[status];}});Ticker.ItemsCount=Class.define(Widget.OptionsContainer,{storageStats:null,id:null,channel:null,read:null,followed:null,initialize:function(options){this.installOptions(options);this.element=$(this.id);this.storageStats.addCallback(this.update.bind(this));this.update();},update:function(){this.element.innerHTML=this.storageStats.countItems(this.channel,this.read,this.followed).toString();}});Ticker.ChannelsCount=Class.define(Widget.OptionsContainer,{storageStats:null,id:null,read:null,followed:null,initialize:function(options){this.installOptions(options);this.element=$(this.id);this.storageStats.addCallback(this.update.bind(this));this.update();},update:function(){this.element.innerHTML=this.storageStats.countChannels(this.read,this.followed).toString();}});Ticker.ItemProperty=Class.define(Widget.OptionsContainer,{id:null,propertyName:null,item:null,initialize:function(options){this.installOptions(options);this.element=$(this.id);this.functionName='get'+this.propertyName.slice(0,1).toUpperCase()+this.propertyName.slice(1);this.update();},setItem:function(item){this.item=item;this.update();},update:function(){if(this.item){this.element.innerHTML=this.item[this.functionName]();}else{this.element.innerHTML='';}}});Ticker.ItemDisplay=Widget.define({popupId:null,itemPropertyId:null,initialize:function(options){this.initializeWidget(null,options);if(this.itemPropertyId){this.itemPropertyIds=this.itemPropertyId.split(",");}
this.addAction("dismiss");},setItem:function(item){if(this.itemPropertyIds){for(var i=0;i<this.itemPropertyIds.length;i++){var itemPropertyId=this.itemPropertyIds[i];var widget=Widget.getInstance(itemPropertyId);if(widget){widget.setItem(item);}}}},show:function(){var popup=this.getPopup();if(popup){popup.show();}},hide:function(){this.dismiss();},dismiss:function(dismissType){var popup=this.getPopup();if(popup){popup.hide();}},getPopup:function(){if(!this.popup){if(this.popupId){this.popup=Widget.getInstance(this.popupId);}}
return this.popup;}});