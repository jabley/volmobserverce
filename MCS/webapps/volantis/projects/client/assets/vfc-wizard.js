
Widget.Wizard=Class.define(Widget.Widget,Widget.Appearable,Widget.Disappearable,{stepsIdsArray:null,initialize:function(id,options){this.initializeWidget(id,options);this.id=id;this.biggestHeight=0;this.formElement=null;this.stepArray=[];this.simpleValidatorIds=[];this.multipleValidatorIds=[];this.stepValidators=null;this.currentIndex=0;this.isDisplayed=false;this.launcherId=null;this.popupInstance=null;this.wizardElement=null;this.clientWidth=window.document.body.clientWidth;this.clientHeight=window.document.body.clientHeight;this.cancelCallbackHandler=new Widget.CallbackHandler();var i;for(i=0;i<this.stepsIdsArray.length;i++){this.registerStep(i,this.stepsIdsArray[i]);}
this.addAction('next');this.addAction('previous');this.addAction('cancel');this.addAction('complete');this.addAction('launch');this.addEvent('completed');this.registrationCompleted();},initStyles:function(){if(Prototype.operaMobile()){var displayHeight;if(window.innerHeight>this.wizardElement.offsetHeight){displayHeight=window.innerHeight;}else{displayHeight=this.wizardElement.offsetHeight;}
Element.setStyle(this.wizardElement,{'position':'absolute','height':displayHeight+'px','top':'0px','left':'0px','z-index':'2','visibility':'visible','display':'none'});}else{var displayWidth=document.documentElement.clientWidth||document.body.clientWidth||window.innerWidth;Element.setStyle(this.wizardElement,{'width':displayWidth+'px','height':'100%','position':'fixed','z-index':'2','top':'0px','left':'0px','visibility':'visible','overflow':'auto','display':'none'});}
if(Prototype.msieBrowser()){this.wizardElement.style.width=document.documentElement.clientWidth-1;this.wizardElement.style.height=document.documentElement.clientHeight-1;this.wizardElement.style.position='absolute';}},hide:function(){if(this.isDisplayed){this.isDisplayed=false;this.reset();Element.hide(this.wizardElement);Element.setStyle(document.body,{'overflow':'hidden'});}},reset:function(){this.formElement.reset();},cancel:function(){this.setButtonsEnabled(false);this.popupInstance.show();},setButtonsEnabled:function(display){var inputs=$(this.id).getElementsByTagName('input');for(var i=0;i<inputs.length;i++){if(inputs[i].type=='button'||inputs[i].type=='submit'){inputs[i].disabled=!display;}}},next:function(){this.validateStep(this.currentIndex);},previous:function(){this.displayStep(this.currentIndex-1);},complete:function(){this.validateStep(this.stepArray.length-1);},goToStep:function(stepIndex){if((stepIndex>=0)&&(stepIndex<this.stepArray.length)){this.displayStep(stepIndex);}},registerSimpleValidator:function(stepIndex,validatorId){if(!this.simpleValidatorIds[stepIndex]){this.simpleValidatorIds[stepIndex]=[];}
this.simpleValidatorIds[stepIndex].push(validatorId);},registerMultipleValidator:function(stepIndex,validatorId){if(this.multipleValidatorIds[stepIndex]===undefined){this.multipleValidatorIds[stepIndex]=new Array();}
this.multipleValidatorIds[stepIndex].push(validatorId);},registerStep:function(stepIndex,stepElement){this.stepArray[stepIndex]=$(stepElement);Element.setStyle(this.stepArray[stepIndex],{'display':'none','visibility':'visible'});},registerLauncher:function(launchElement){this.launcherId=launchElement;},registerPopup:function(popupId){this.popupInstance=Widget.getInstance(popupId);this.observe(this.popupInstance,"dismissed","doCancel");},registrationCompleted:function(){this.wizardElement=$(this.id);var formArray=$A(this.wizardElement.getElementsByTagName('form'));this.formElement=formArray[0];this.initStyles();if(this.launcherId){this.addInputElement($(this.launcherId));}},getStepValidators:function(){if(this.stepValidators===null){this.initializeStepValidators();}
return this.stepValidators;},initializeStepValidators:function(){this.stepValidators=new Array();for(var index=0;index<this.stepArray.length;index++){var simpleValidatorIds=this.simpleValidatorIds[index];var multipleValidatorIds=this.multipleValidatorIds[index];var simpleValidator=null;var multipleValidator=null;if(simpleValidatorIds){var simpleValidators=[];for(subIndex=0;subIndex<simpleValidatorIds.length;subIndex++){simpleValidators.push(Widget.getInstance(simpleValidatorIds[subIndex]));}
simpleValidator=new Widget.ChainedValidator(simpleValidators,{failFast:false});}
if(multipleValidatorIds){var multipleValidators=[];for(subIndex=0;subIndex<multipleValidatorIds.length;subIndex++){multipleValidators.push(Widget.getInstance(multipleValidatorIds[subIndex]));}
multipleValidator=new Widget.ChainedValidator(multipleValidators,{failFast:true});}
if(simpleValidator===null){if(multipleValidator===null){stepValidator=null;}else{stepValidator=multipleValidator;}}else{if(multipleValidator===null){stepValidator=simpleValidator;}else{stepValidator=new Widget.ChainedValidator(new Array(simpleValidator,multipleValidator),{failFast:true});}}
if(stepValidator!==null){stepValidator.addSuccessCallback(this.onValidatorSuccess.bind(this));stepValidator.addFailureCallback(this.onValidatorFailure.bind(this));stepValidator.addFallbackCallback(this.onValidatorFallback.bind(this));this.stepValidators[index]=stepValidator;}}},doCancel:function(message){if(message=="yes"){this.hide();this.cancelCallbackHandler.invoke();Element.setStyle(this.stepArray[this.currentIndex],{'display':'none','visibility':'visible'});Element.setStyle(document.body,{'overflow':'auto'});}else{this.setButtonsEnabled(true);}},addCancelCallback:function(callback){this.cancelCallbackHandler.add(callback);},setCurrentIndex:function(newIndex){this.currentIndex=newIndex;},showCurrentStep:function(){this.currentStep=this.stepArray[this.currentIndex];var it=this;this.setButtonsEnabled(false);Widget.TransitionFactory.createAppearEffect(this.currentStep,this,{afterFinish:function(effect){it.setButtonsEnabled(true);}});},hideCurrentStep:function(){this.currentStep=this.stepArray[this.currentIndex];this.setButtonsEnabled(false);var it=this;Widget.TransitionFactory.createDisappearEffect(this.currentStep,this,{afterFinish:function(effect){it.setButtonsEnabled(true);}});},displayStep:function(stepIndex){this.currentStep=this.stepArray[this.currentIndex];this.nextStep=this.stepArray[stepIndex];this.setButtonsEnabled(false);var n=this.nextStep;var it=this;Widget.TransitionFactory.createDisappearEffect(this.currentStep,this,{afterFinish:function(effect){Widget.TransitionFactory.createAppearEffect(n,it,{afterFinish:function(effect){it.setButtonsEnabled(true);it.prepareScrolling(n);}});}});this.setCurrentIndex(stepIndex);},prepareScrolling:function(step){if(Prototype.operaMobile()){if(window.innerHeight>step.offsetHeight){Element.setStyle(document.body,{'overflow':'hidden'});}else{Element.setStyle(document.body,{'overflow':'scroll'});}}},validateStep:function(stepIndex){var stepValidators=this.getStepValidators();var stepValidator=stepValidators[stepIndex];if(!stepValidator){this.onValidatorSuccess();}else{stepValidator.validate();}},nextAfterValidation:function(){this.displayStep(this.currentIndex+1);},completeAfterValidation:function(){this.currentStep=this.stepArray[this.currentIndex];this.setButtonsEnabled(false);var it=this;Widget.TransitionFactory.createDisappearEffect(this.currentStep,this,{afterFinish:function(effect){it.doSubmit();}});},doSubmit:function(){this.formElement.submit();this.notifyObservers("completed");},nextOrCompleteAfterValidation:function(){if(this.currentIndex!=this.stepArray.length-1){this.nextAfterValidation();}else{this.completeAfterValidation();}},onValidatorSuccess:function(){this.nextOrCompleteAfterValidation();},onValidatorFailure:function(){},onValidatorFallback:function(){this.nextOrCompleteAfterValidation();},addInputElement:function(el){var imp=document.createElement("input");imp.type="button";imp.style.width='1px';imp.style.height='1px';imp.style.backgroundColor='transparent';imp.style.border='0px';el.appendChild(imp);},launch:function(){if(!this.isDisplayed){this.isDisplayed=true;this.prepareScrolling(this.wizardElement);Element.show(this.wizardElement);this.setCurrentIndex(0);this.showCurrentStep();}},show:function(){this.launch();}});