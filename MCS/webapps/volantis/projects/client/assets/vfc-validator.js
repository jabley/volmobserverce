
Widget.ValidatorCallbackHandler=Class.define(Widget.OptionsContainer,{initialize:function(options){this.installOptions(options);this.successCallbackHandler=new Widget.CallbackHandler();this.failureCallbackHandler=new Widget.CallbackHandler();this.fallbackCallbackHandler=new Widget.CallbackHandler();if(this.getOption('onSuccess')){this.successCallbackHandler.add(this.getOption('onSuccess'));}
if(this.getOption('onFailure')){this.failureCallbackHandler.add(this.getOption('onFailure'));}
if(this.getOption('onFallback')){this.fallbackCallbackHandler.add(this.getOption('onFallback'));}},addOnSuccess:function(callback){this.successCallbackHandler.add(callback);},addOnFailure:function(callback){this.failureCallbackHandler.add(callback);},addOnFallback:function(callback){this.fallbackCallbackHandler.add(callback);},invokeOnSuccess:function(){this.successCallbackHandler.invoke.apply(this.successCallbackHandler,arguments);},invokeOnFailure:function(){this.failureCallbackHandler.invoke.apply(this.failureCallbackHandler,arguments);},invokeOnFallback:function(){this.fallbackCallbackHandler.invoke.apply(this.fallbackCallbackHandler,arguments);}});Widget.ValidatorCallbackMixin=Class.define({addSuccessCallback:function(callback){this.callbackHandler.addOnSuccess(callback);},addFailureCallback:function(callback){this.callbackHandler.addOnFailure(callback);},addFallbackCallback:function(callback){this.callbackHandler.addOnFallback(callback);}});Widget.ValidationVisualizer=Class.define(Widget.Observer,Widget.OptionsContainer,{inputId:null,labelId:null,messageAreaId:null,invalidInputStyle:null,invalidLabelStyle:null,autoFocus:false,popupId:null,displayAlerts:false,onDismiss:null,initialize:function(options){this.installOptions(options);},validationFailed:function(message){this.setInvalidStyle();this.setMessage(message);this.showPopup(message);if(this.displayAlerts){alert(message.unescapeHTML());}
if(!this.getPopup()){this.visualizationDismissed();}},validationPassed:function(){this.setOriginalStyle();this.dismissPopup();this.setMessage();},getInputElement:function(){if(this.inputId){return $(this.inputId);}},getLabelElement:function(){if(this.labelId){return $(this.labelId);}},getPopup:function(){if(!this.popup){this.popup=Widget.getInstance(this.popupId);if(this.popup){this.observe(this.popup,"dismissed","visualizationDismissed");}}
return this.popup;},getMessageArea:function(){return $(this.messageAreaId);},setInvalidStyle:function(){this.setOriginalStyle();var inputElement=this.getInputElement();if(inputElement){if(this.invalidInputStyle){inputElement.vfcReplaceStyle(this.invalidInputStyle);}}
var labelElement=this.getLabelElement();if(labelElement){if(this.invalidLabelStyle){labelElement.vfcReplaceStyle(this.invalidLabelStyle);}}},setOriginalStyle:function(){var inputElement=this.getInputElement();if(inputElement){inputElement.vfcRevertStyle();}
var labelElement=this.getLabelElement();if(labelElement){labelElement.vfcRevertStyle();}},setFocus:function(){var inputElement=this.getInputElement();if(inputElement){inputElement.focus();}},showPopup:function(message){popup=this.getPopup();if(popup){popup.show();}},dismissPopup:function(){popup=this.getPopup();if(popup){popup.hide();}},setMessage:function(message){messageArea=this.getMessageArea();if(messageArea){messageArea.innerHTML=message?message:"";}},visualizationDismissed:function(){if(this.autoFocus){this.setFocus();}
if(this.onDismiss){setTimeout(this.onDismiss,0);}}});Widget.OfflineValidationEngine=Class.define(Widget.OptionsContainer,{inputFormat:null,initialize:function(inputFormat){this.inputFormat=inputFormat;},validate:function(value){var result=true;if(this.inputFormat){var matcher=new RegEx(this.inputFormat,value);result=matcher.match();}
return result;},setInputFormat:function(inputFormat){this.inputFormat=inputFormat;}});Widget.OnlineValidationEngine=Class.define(Widget.OptionsContainer,Widget.ValidatorCallbackMixin,{url:null,initialize:function(options){this.installOptions(options);this.callbackHandler=new Widget.ValidatorCallbackHandler(options);},validate:function(fields){if(!this.url){this.validationPassed();}else{this.request=new Widget.AjaxRequest(this.url,{parameters:$H(fields).toQueryString(),method:"get",onSuccess:this.onAJAXRequestSuccess.bind(this),onFailure:this.onAJAXRequestFailure.bind(this),onException:this.onAJAXRequestFailure.bind(this)});}},onAJAXRequestSuccess:function(httpRequest){this.response=httpRequest.responseText;this.getResponseArea().innerHTML=this.response.stripScripts();setTimeout(this.evalResponseScripts.bind(this),10);},onAJAXRequestFailure:function(){this.validationFallback();},createResponseArea:function(){var responseArea=document.createElement("div");var responseAreaElement=Element.extend(responseArea);responseAreaElement.setStyle({display:'none'});document.body.appendChild(responseArea);return responseAreaElement;},getResponseArea:function(){if(!this.responseArea){this.responseArea=this.createResponseArea();}
return this.responseArea;},evalResponseScripts:function(){this.responseProcessed=false;Widget.currentOnlineValidationEngine=this;this.response.evalScripts();this.getResponseArea().innerHTML="";Widget.currentOnlineValidationEngine=null;if(!this.responseProcessed){this.validationFallback();}},processResponse:function(result,messageId,fieldMessageIds){if(result){this.validationPassed();}else{var message=messageId?$(messageId).innerHTML:null;var fieldMessages={};for(var id in fieldMessageIds){fieldMessages[id]=fieldMessageIds[id]?$(fieldMessageIds[id]).innerHTML:null;}
this.validationFailed(message,fieldMessages);}
this.responseProcessed=true;},validationFailed:function(message,fieldMessages){this.callbackHandler.invokeOnFailure(message,fieldMessages);},validationPassed:function(){this.callbackHandler.invokeOnSuccess();},validationFallback:function(){this.callbackHandler.invokeOnFallback();},setURL:function(url){this.url=url;}});Widget.processOnlineValidationEngineResponse=function(result,messageId,fieldMessageIds){var engine=Widget.currentOnlineValidationEngine;if(engine){engine.processResponse(result,messageId,fieldMessageIds);}};Widget.isSimpleValidationDisabled=false;Widget.SimpleValidator=Class.define(Widget.OptionsContainer,Widget.ValidatorCallbackMixin,{inputId:null,inputFormat:null,url:null,emptyMessageId:null,invalidMessageId:null,emptyMessage:"Input required",invalidMessage:"Input invalid",initialize:function(options){this.installOptions(options);this.callbackHandler=new Widget.ValidatorCallbackHandler(options);this.offlineEngine=new Widget.OfflineValidationEngine(this.inputFormat);this.onlineEngine=new Widget.OnlineValidationEngine({url:this.url,onSuccess:this.onEngineSuccess.bind(this),onFailure:this.onEngineFailure.bind(this),onFallback:this.onEngineFallback.bind(this)});this.visualizer=new Widget.ValidationVisualizer(options);this.visualizer.onDismiss=this.onVisualizerDismiss.bind(this);},validate:function(){if(Widget.isSimpleValidationDisabled){return;}
if(this.offlineEngine){var inputValue=this.getInputValue();offlineResult=this.offlineEngine.validate(inputValue);if(!offlineResult){if(inputValue===""){this.onEngineFailure(this.getEmptyMessage());}else{this.onEngineFailure(this.getInvalidMessage());}
return;}}
if(this.onlineEngine){this.onlineEngine.validate();}else{this.onEngineSuccess();}},validateOffline:function(){if(this.offlineEngine){var inputValue=this.getInputValue();result=this.offlineEngine.validate(inputValue);if(result){this.onEngineSuccess();}else{if(inputValue===""){this.onEngineFailure(this.getEmptyMessage());}else{this.onEngineFailure(this.getInvalidMessage());}}}
return result;},validationPassed:function(){this.visualizer.validationPassed();this.callbackHandler.invokeOnSuccess();},validationFailed:function(message){Widget.isSimpleValidationDisabled=true;this.visualizer.validationFailed(message);},onEngineSuccess:function(){this.validationPassed();},onEngineFailure:function(message,fieldMessages){this.validationFailed(message);},onEngineFallback:function(){this.callbackHandler.invokeOnFallback();},onVisualizerDismiss:function(){Widget.isSimpleValidationDisabled=false;this.callbackHandler.invokeOnFailure();},getInputElement:function(){return $(this.inputId);},getInputValue:function(){return this.getInputElement().value;},getEmptyMessageElement:function(){if(this.emptyMessageId){return $(this.emptyMessageId);}},getInvalidMessageElement:function(){if(this.invalidMessageId){return $(this.invalidMessageId);}},getEmptyMessage:function(){var element=this.getEmptyMessageElement();if(element){return element.innerHTML;}else{return this.emptyMessage;}},getInvalidMessage:function(){var element=this.getInvalidMessageElement();if(element){return element.innerHTML;}else{return this.invalidMessage;}},setInputFormat:function(inputFormat){this.inputFormat=inputFormat;this.offlineEngine.setInputFormat(inputFormat);},setURL:function(url){this.url=url;this.onlineEngine.setURL(url);}});Widget.processSimpleValidatorResponse=function(result,messageId){Widget.processOnlineValidationEngineResponse(result,messageId,{});};Widget.MultipleValidator=Class.define(Widget.OptionsContainer,Widget.ValidatorCallbackMixin,{fields:{},url:null,messageArea:null,autoFocus:false,popup:null,autoFocus:false,initialize:function(options){this.installOptions(options);this.callbackHandler=new Widget.ValidatorCallbackHandler(options);this.engine=new Widget.OnlineValidationEngine({url:this.url,onSuccess:this.onEngineSuccess.bind(this),onFailure:this.onEngineFailure.bind(this),onFallback:this.onEngineFallback.bind(this)});this.visualizer=new Widget.ValidationVisualizer(options);this.visualizer.onDismiss=this.setFocus.bind(this);this.visualizers={};for(var id in this.fields){this.visualizers[id]=new Widget.ValidationVisualizer(this.fields[id]);}},validate:function(){this.prepareForValidation();this.validateSimpleThenMultiple();},validateForWizard:function(){this.prepareForValidation();this.validateMultiple();},prepareForValidation:function(){this.focusElement=null;for(var id in this.visualizers){this.visualizers[id].validationPassed();}
this.visualizer.validationPassed();},getSimpleValidator:function(){if(!this.simpleValidator){var simpleValidators=new Array();for(var id in this.fields){var validator=Widget.getInstance(this.fields[id].inputId);if(validator){simpleValidators.push(validator);}}
this.simpleValidator=new Widget.ChainedValidator(simpleValidators,{failFast:false,onSuccess:this.onSimpleSuccess.bind(this),onFailure:this.onSimpleFailure.bind(this),onFallback:this.onSimpleFallback.bind(this)});}
return this.simpleValidator;},validateSimpleThenMultiple:function(){this.getSimpleValidator().validate();},validateMultiple:function(){var fieldValues=this.getFieldValues();this.engine.validate(fieldValues);},onSimpleSuccess:function(){this.validateMultiple();},onSimpleFailure:function(){this.callbackHandler.invokeOnFailure();},onSimpleFallback:function(){this.callbackHandler.invokeOnFallback();},onEngineSuccess:function(){this.callbackHandler.invokeOnSuccess();},onEngineFailure:function(message,fields){var firstFailedField=true;for(var id in this.fields){if(fields[id]===undefined){this.visualizers[id].validationPassed();}else{this.visualizers[id].validationFailed(fields[id]);if(firstFailedField&&this.autoFocus){this.focusElement=this.getInputElement(id);firstFailedField=false;}}}
this.visualizer.validationFailed(message);this.callbackHandler.invokeOnFailure();},onEngineFallback:function(){this.callbackHandler.invokeOnFallback();},getInputElement:function(id){return $(this.fields[id].inputId);},getFieldValues:function(){var values={};for(var id in this.fields){values[id]=this.getInputElement(id).value;}
return values;},setURL:function(url){this.url=url;this.engine.setURL(url);},setFocus:function(){if(this.focusElement){this.focusElement.focus();}}});Widget.processMultipleValidatorResponse=function(result,message,fields){Widget.processOnlineValidationEngineResponse(result,message,fields);};Widget.processValidatorResponse=function(result,message,fields){Widget.processOnlineValidationEngineResponse(result,message,fields);};Widget.ChainedValidator=Class.define(Widget.OptionsContainer,Widget.ValidatorCallbackMixin,{validators:null,failFast:false,initialize:function(validators,options){this.installOptions(options);this.validators=validators?validators:new Array();this.callbackHandler=new Widget.ValidatorCallbackHandler(options);for(index=0;index<this.validators.length;index++){var validator=this.validators[index];validator.addSuccessCallback(this.onValidatorSuccess.bind(this));validator.addFailureCallback(this.onValidatorFailure.bind(this));validator.addFallbackCallback(this.onValidatorFallback.bind(this));}
this.isDuringValidation=false;},validate:function(){this.isDuringValidation=true;this.nextValidatorIndex=0;this.currentResult=true;this.validateNextStep();},validateNextStep:function(){var finishValidation=false;if(this.currentResult!==true){if(this.failFast){finishValidation=true;}}
if(this.nextValidatorIndex>=this.validators.length){finishValidation=true;}
if(finishValidation){this.finishValidation();}else{validator=this.validators[this.nextValidatorIndex];validator.validate();}},validateStepFinished:function(){this.nextValidatorIndex++;this.validateNextStep();},onValidatorSuccess:function(){if(this.isDuringValidation){this.validateStepFinished();}},onValidatorFailure:function(){if(this.isDuringValidation){if(this.currentResult===true){this.currentResult=false;}
this.validateStepFinished();}},onValidatorFallback:function(){if(this.isDuringValidation){if(this.currentResult===true){this.currentResult=null;}
this.validateStepFinished();}},finishValidation:function(){if(this.currentResult===true){this.callbackHandler.invokeOnSuccess();}else if(this.currentResult===false){this.callbackHandler.invokeOnFailure();}else{this.callbackHandler.invokeOnFallback();}
this.isDuringValidation=false;}});