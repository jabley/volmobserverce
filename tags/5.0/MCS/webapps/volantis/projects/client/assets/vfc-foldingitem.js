
Widget.FoldingItem=Class.create();Object.extend(Widget.FoldingItem.prototype,Widget.Appearable);Object.extend(Widget.FoldingItem.prototype,Widget.Disappearable);Object.extend(Widget.FoldingItem.prototype,{initialize:function(id,options){this.unfoldon="click";this.folded=true;this.showlabel=true;this.foldedSpan=0;this.unfoldedSpan=0;this.ftElementId=null;this.fdElementId=null;this.foldedSpanId=null;this.unfoldedSpanId=null;this.load_src=0;this.load_when=0;this.unfoldedElementStyle={};this.unfoldedFtElementStyle={};this.initial_state='inactive';Object.copyFields(this,options||{});this.locked=false;this.isFocus=false;this.id=id;this.element=$(id);this.ftElement=$(this.ftElementId);this.fdElement=$(this.fdElementId);this.foldedSpan=$(this.foldedSpanId);this.unfoldedSpan=$(this.unfoldedSpanId);this.folded=(this.initial_state!='active');if(this.folded){this.fdElement.style.display='none';this.unfoldedSpan.style.display='none';this.foldedSpan.style.display='inline';}else{this.foldedSpan.style.display='none';this.unfoldedSpan.style.display='inline';}
if(Prototype.firefoxBrowser()&&this.unfoldon=='focus'){this.fdElement.parentNode.style.overflow='hidden';}
this.changeStyle();this.focuser=Widget.makeFocusable(this.ftElement);this.gotResponse=false;this.setObservers();if(this.load_when=="onload"){this.loadAjax();}},setObservers:function(){if(this.unfoldon=='click'){Widget.addElementObserver(this.ftElement,Widget.CLICK,this.doClick.bindAsEventListener(this));if(this.focuser){Widget.addElementObserver(this.focuser,Widget.CLICK,this.doClick.bindAsEventListener(this));}
if(!this.showlabel){Widget.addElementObserver(this.closeMarker,Widget.CLICK,this.doClick.bindAsEventListener(this));}}else{if(this.focuser){Widget.addElementObserver(this.focuser,Widget.FOCUS,this.doUnfold.bindAsEventListener(this));Widget.addElementObserver(this.focuser,Widget.BLUR,this.doFold.bindAsEventListener(this));}}},changeStyle:function(){if(this.folded){this.element.vfcRevertStyle();this.ftElement.vfcRevertStyle();}else{this.element.vfcReplaceStyle(this.unfoldedElementStyle);this.ftElement.vfcReplaceStyle(this.unfoldedFtElementStyle);}},loadAjax:function(){if(this.load_src&&!this.gotResponse){new Widget.AjaxUpdater(this.fdElement.firstChild,this.load_src,{asynchronous:true,method:'get'});this.gotResponse=true;}},afterEffect:function(){this.locked=false;this.checkFocus();},checkFocus:function(){if(this.unfoldon=="focus"){if(this.folded&&this.isFocus){this.doUnfold();}else if(!this.folded&&!this.isFocus){this.doFold();}}},doClick:function(evt){Widget.stopEventPropagation(evt);if(this.folded){this.doUnfold();}else{this.doFold();}},doFold:function(){this.isFocus=false;if(!this.folded&&!this.locked){this.locked=true;this.folded=true;this.changeStyle();var it=this;Widget.TransitionFactory.createDisappearEffect(this.fdElement,this,{afterFinish:function(effect){it.afterEffect();}});this.unfoldedSpan.style.display="none";this.foldedSpan.style.display="inline";}},doUnfold:function(){this.isFocus=true;if(this.folded&&!this.locked){this.locked=true;this.folded=false;this.loadAjax();this.changeStyle();this.foldedSpan.style.display="none";this.unfoldedSpan.style.display="inline";this.fdElement.parentNode.style.overflow='hidden';var it=this;Widget.TransitionFactory.createAppearEffect(this.fdElement,this,{afterFinish:function(effect){it.afterEffect();}});}},fold:function(){this.doFold();},unfold:function(){this.doUnfold();}});