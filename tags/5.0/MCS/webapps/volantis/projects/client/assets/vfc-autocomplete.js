
Widget.Autocompleter=Class.create();Object.extend(Widget.Autocompleter.prototype,Widget.Appearable);Object.extend(Widget.Autocompleter.prototype,Widget.Disappearable);Object.extend(Object.extend(Widget.Autocompleter.prototype,Autocompleter.Base.prototype),{initialize:function(element,update,options){this.id=update;this.baseInitialize(element,update,options);this.options.asynchronous=true;this.options.onComplete=this.onComplete.bind(this);this.options.defaultParams=this.options.parameters||null;this.url='';this.isHideProgress=false;this.lagTime=1;this.itemLimit=5;this.defaultActiveStyle={"background-color":"yellow"};this.options.paramName='mcs-value';Object.copyFields(this,options||{});this.options.frequency=this.lagTime;this.options.defaultParams='mcs-item-limit='+this.itemLimit;this.activeStyles=[];this.setup();},setup:function(){this.update.style.position='absolute';if(!Prototype.operaPC()){if(this.update.getStyle('width')!='0px'){this.update.style.width=this.update.getStyle('width');}}else{var originalWidth=parseInt(this.update.getStyle('width'))-parseInt(this.update.getStyle('border-left-width'))-parseInt(this.update.getStyle('border-right-width'));if(originalWidth!=0){this.update.style.width=originalWidth+'px';}}},getUpdatedChoices:function(){entry=encodeURIComponent(this.options.paramName)+'='+
encodeURIComponent(this.getToken());this.options.parameters=this.options.callback?this.options.callback(this.element,entry):entry;if(this.options.defaultParams){this.options.parameters+='&'+this.options.defaultParams;}
this.options.onSuccess=this.onAJAXRequestSuccess.bind(this);this.options.method="get";new Ajax.Request(this.url,this.options);},onComplete:function(request){this.updateChoices(this.response.stripScripts());},updateChoices:function(choices){if(!this.changed&&this.hasFocus){if(choices.indexOf("li")!=-1){this.limitExecutor(choices);this.update.innerHTML=this.responseHtml;Element.cleanWhitespace(this.update);Element.cleanWhitespace(this.update.firstChild);if(this.update.firstChild&&this.update.firstChild.childNodes){this.entryCount=this.update.firstChild.childNodes.length;for(var i=0;i<this.entryCount;i++){var entry=this.getEntry(i);entry.autocompleteIndex=i;this.addObservers(entry);}}else{this.entryCount=0;}}else{this.entryCount=0;}
if(Prototype.nokiaOSSBrowser()){this.prepereItems();}
this.stopIndicator();this.index=0;this.render();}},limitExecutor:function(items){this.entryCount=0;this.responseHtml=items;var lastIndex=this.responseHtml.lastIndexOf('</ul>');var firstIndex=this._getPosition(0);if(firstIndex!=-1){this.responseHtml=this.responseHtml.substring(0,firstIndex)+this.responseHtml.substring(lastIndex,this.responseHtml.length);}},_getPosition:function(startIndex){var poz=this.responseHtml.indexOf("<li",startIndex);if(poz!=-1){this.entryCount++;if(this.entryCount>this.itemLimit){return poz;}else{return this._getPosition(poz+1);}}else{return-1;}},prepereItems:function(){var textNode,textValue;var i=0;while(i<this.entryCount){var itemNode=this.getEntry(i);var a=document.createElement("a");a.href="javascript:void(null)";a.style.textDecoration='none';a.style.color='black';if(itemNode.childNodes.length==1&&itemNode.firstChild.nodeType==3){textNode=itemNode.firstChild;textValue=itemNode.innerHTML;a.appendChild(document.createTextNode(textValue));itemNode.replaceChild(a,textNode);}else{textNode=this.findTextNode(itemNode);textValue=textNode.nodeValue;a.appendChild(document.createTextNode(textValue));textNode.parentNode.replaceChild(a,textNode);}
i++;}},findTextNode:function(item){var textNode;for(var i=0;i<item.childNodes.length;i++){var child=item.childNodes[i];if(child.nodeType==3){return child;}else{textNode=this.findTextNode(child);if(textNode){return textNode;}}}},addObservers:function(element){Event.observe(element,"mouseover",this.onHover.bindAsEventListener(this));Event.observe(element,"click",this.onClick.bindAsEventListener(this));},evalResponseScripts:function(){var scripts=this.response.extractScriptsWithSubstring();scripts.each(function(script){eval('this.'+script);}.bind(this));},registerActiveStyle:function(idLi,style){this.activeStyles[idLi]=style;},onAJAXRequestSuccess:function(httpRequest){this.response=httpRequest.responseText;this.evalResponseScripts();}});